<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gest√£o de Insumos</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.29/jspdf.plugin.autotable.min.js"></script>
    <link rel="stylesheet" href="main.css?v=ADUBO-OS-FIX-49-FLOW-DEBUG">
</head>
<body>
    <!-- Configura√ß√£o de API Key -->
    <div id="api-key-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 10000; justify-content: center; align-items: center;">
        <div style="background: var(--bg-card); padding: 20px; border-radius: 8px; width: 90%; max-width: 400px; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
            <h2 style="margin-top: 0;">Configura√ß√£o de IA</h2>
            <p style="margin-bottom: 15px;">Para usar a leitura autom√°tica de O.S., voc√™ precisa fornecer sua chave de API do Google Gemini.</p>
            <p style="font-size: 0.8em; color: var(--text-muted); margin-bottom: 15px;">A chave ser√° salva apenas no seu navegador (Local Storage) e nunca ser√° enviada para nosso servidor.</p>
            
            <div style="margin-bottom: 15px;">
                <label for="gemini-api-key-input" style="display: block; margin-bottom: 5px; font-weight: bold;">Chave API Gemini:</label>
                <input type="password" id="gemini-api-key-input" placeholder="Cole sua chave aqui (AIza...)" style="width: 100%; padding: 10px; border: 1px solid var(--border-color); border-radius: 4px; background: var(--bg-input); color: var(--text-color);">
            </div>
            
            <div style="display: flex; justify-content: flex-end; gap: 10px;">
                <button id="cancel-api-key-btn" class="btn btn-secondary">Cancelar</button>
                <button id="save-api-key-btn" class="btn btn-primary" style="background-color: #2196F3; color: white;">Salvar Chave</button>
            </div>
            
            <div style="margin-top: 15px; text-align: center; font-size: 0.9em;">
                <a href="https://aistudio.google.com/app/apikey" target="_blank" style="color: #2196F3; text-decoration: none;">N√£o tem uma chave? Gere gratuitamente aqui ‚Üó</a>
            </div>
        </div>
    </div>

    <div class="app-container">
        
        <!-- Tela de Login (Full Screen Overlay) -->
        <div id="login-screen" class="login-screen" style="display:flex;">
            <div class="login-box">
                <h2>Controle de Insumos</h2>
                <p style="opacity:0.8;margin-bottom:12px;">Acesse para liberar o software</p>
                <div class="form-grid boletim-grid">
                    <div class="form-group">
                        <label for="login-user">Email</label>
                        <input type="email" id="login-user" placeholder="email@exemplo.com">
                    </div>
                    <div class="form-group">
                        <label for="login-pass">Senha</label>
                        <input type="password" id="login-pass" placeholder="123456">
                    </div>
                </div>
                <div style="margin-top:10px;display:flex;gap:10px;justify-content:space-between;align-items:center;">
                    <button id="login-register-toggle" class="btn btn-secondary">Cadastrar</button>
                    <div style="display:flex;gap:10px;">
                        <button id="login-btn" class="btn btn-primary">Entrar</button>
                    </div>
                </div>
                <div id="register-area" style="display:none;margin-top:12px;">
                    <div class="form-grid">
                        <div class="form-group">
                            <label for="register-user">Usu√°rio (Login)</label>
                            <input type="text" id="register-user" placeholder="ex.: joao123">
                        </div>
                        <div class="form-group">
                            <label for="register-email">Email</label>
                            <input type="email" id="register-email" placeholder="joao@exemplo.com">
                        </div>
                        <div class="form-group">
                            <label for="register-pass">Senha</label>
                            <input type="password" id="register-pass" placeholder="min. 6 caracteres">
                        </div>
                        <div class="form-group">
                            <label for="register-firstname">Nome</label>
                            <input type="text" id="register-firstname" placeholder="Primeiro Nome">
                        </div>
                        <div class="form-group">
                            <label for="register-lastname">Sobrenome</label>
                            <input type="text" id="register-lastname" placeholder="Sobrenome">
                        </div>
                    </div>
                    <div style="margin-top:10px;display:flex;gap:10px;justify-content:flex-end;">
                        <button id="register-btn" class="btn btn-success">Criar Conta</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Conte√∫do do App (Escondido at√© login) -->
        <div id="app-content" style="display:none; flex-direction: column; height: 100%;">
            <!-- Header -->
            <header class="header">
                <h1>üß™ Gest√£o de Insumos Agr√≠colas</h1>
                <div class="header-actions">
                    <div class="actions-dropdown">
                        <button id="more-actions-btn" class="btn btn-secondary">‚ãØ Mais A√ß√µes</button>
                        <div id="more-actions-menu" class="dropdown-menu">
                            <button id="config-api-key-btn" class="btn btn-secondary">üîë Configurar API Key</button>
                            <button id="export-csv-btn" class="btn btn-secondary">‚¨áÔ∏è Exportar CSV</button>
                            <button id="export-excel-btn" class="btn btn-secondary">‚¨áÔ∏è Exportar Excel</button>
                            <button id="export-pdf-btn" class="btn btn-secondary">‚¨áÔ∏è Exportar PDF</button>
                            <button id="clear-import-btn" class="btn btn-secondary">üóëÔ∏è Limpar Hist√≥rico</button>
                            <button id="logout-btn" class="btn btn-secondary">Sair</button>
                        </div>
                    </div>
                    <div id="admin-panel-btn-container" style="display:inline-block;">
                        <button id="admin-panel-btn" class="btn btn-secondary" style="display:none; background-color: #673AB7; color: white;">üõ°Ô∏è Admin</button>
                    </div>
                    <button id="theme-toggle" class="btn btn-secondary">üåì Tema</button>
                    <span id="current-user" class="user-badge" title="Usu√°rio autenticado" style="display:none;"></span>
                </div>
            </header>

            <!-- Tela de Atualiza√ß√£o Cadastral -->
            <div id="update-profile-screen" class="login-screen" style="display:none; z-index: 9999;">
                <div class="login-box">
                    <h2>Atualiza√ß√£o Cadastral</h2>
                    <p style="opacity:0.8;margin-bottom:12px;">Por favor, complete seu cadastro para continuar.</p>
                    <div class="form-grid">
                        <div class="form-group">
                            <label for="update-name">Nome Completo</label>
                            <input type="text" id="update-name" placeholder="Nome Completo">
                        </div>
                        <div class="form-group">
                            <label for="update-matricula">Matr√≠cula</label>
                            <input type="text" id="update-matricula" placeholder="12345">
                        </div>
                    </div>
                    <div style="margin-top:10px;display:flex;gap:10px;justify-content:flex-end;">
                        <button id="update-profile-btn" class="btn btn-primary">Salvar e Continuar</button>
                    </div>
                </div>
            </div>

            <!-- Admin Modal -->
            <div id="modal-plantio-details" class="modal" style="display: none; z-index: 10001;">
                <div class="modal-content" style="max-width: 900px;">
                    <div class="modal-header">
                        <h3>üìã Detalhes do Plantio</h3>
                        <button class="close-modal close-plantio-details-modal" onclick="document.getElementById('modal-plantio-details').style.display='none'">&times;</button>
                    </div>
                    <div class="modal-body" id="modal-plantio-details-body">
                        <!-- Conte√∫do ser√° injetado via JS -->
                    </div>
                </div>
            </div>

            <!-- Admin Panel (Full Screen) -->
            <div id="admin-modal" class="admin-full-screen" style="display: none;">
                <div class="admin-header">
                    <h3 style="margin:0; font-size:1.5rem; display:flex; align-items:center; gap:10px;">
                        üõ°Ô∏è Painel Administrativo
                    </h3>
                    <button class="btn btn-secondary close-admin-modal">Voltar ao Sistema</button>
                </div>
                <div class="admin-content">
                    <div class="tabs admin-tabs" style="margin-bottom: 20px;">
                            <button class="tab active" data-tab="admin-users">üë• Usu√°rios</button>
                            <button class="tab" data-tab="admin-logs">üìú Hist√≥rico (Audit)</button>
                            <button class="tab" data-tab="admin-system">‚öôÔ∏è Sistema</button>
                        </div>

                        <!-- Tab Usu√°rios -->
                        <div id="admin-users" class="tab-content active">
                            <p style="margin-bottom: 15px;">Gerencie usu√°rios e permiss√µes de acesso.</p>
                            <div class="table-container" style="max-height: 400px; overflow-y: auto;">
                                <table class="data-table">
                                    <thead>
                                        <tr>
                                            <th>Usu√°rio</th>
                                            <th>Email</th>
                                            <th>Nome</th>
                                            <th>Role</th>
                                            <th>A√ß√µes</th>
                                        </tr>
                                    </thead>
                                    <tbody id="admin-users-list">
                                        <tr><td colspan="5" class="loading">Carregando...</td></tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>

                        <!-- Tab Hist√≥rico -->
                        <div id="admin-logs" class="tab-content">
                            <p style="margin-bottom: 15px;">Hist√≥rico de atividades do sistema.</p>
                            <div class="table-container" style="max-height: 400px; overflow-y: auto;">
                                <table class="data-table">
                                    <thead>
                                        <tr>
                                            <th>Data/Hora</th>
                                            <th>Usu√°rio</th>
                                            <th>A√ß√£o</th>
                                            <th>Detalhes</th>
                                        </tr>
                                    </thead>
                                    <tbody id="admin-logs-list">
                                        <tr><td colspan="4" class="loading">Carregando...</td></tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>

                        <!-- Tab Sistema -->
                        <div id="admin-system" class="tab-content">
                            <p style="margin-bottom: 15px;">Configura√ß√µes e Manuten√ß√£o do Sistema.</p>
                            
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                                <div style="padding: 20px; border: 1px solid #ddd; border-radius: 8px; text-align: center; background-color: #f9f9f9;">
                                    <h4 style="margin-top:0;">üöÄ Controle de Vers√£o</h4>
                                    <p style="color: #666; font-size: 0.9em; margin: 10px 0 20px 0;">
                                        Ao for√ßar uma atualiza√ß√£o, todos os usu√°rios conectados ser√£o notificados e suas p√°ginas ser√£o recarregadas automaticamente para receber a nova vers√£o.
                                    </p>
                                    <button id="admin-force-update-btn" class="btn btn-primary" style="background-color: #f44336; width: 100%;">üîÑ For√ßar Atualiza√ß√£o Geral</button>
                                    <p id="admin-last-update-info" style="margin-top: 15px; font-size: 0.85em; color: #888;"></p>
                                </div>
                            </div>
                        </div>
                    </div>
            </div>

            <!-- Permissions Modal -->
            <div id="permissions-modal" class="modal" style="display: none; z-index: 10001; align-items: center; justify-content: center;">
                <div class="modal-content" style="max-width: 500px; max-height: 85vh; overflow-y: auto; margin: auto;">
                    <div class="modal-header">
                        <h3>üîí Permiss√µes de Acesso</h3>
                        <button class="close-modal close-permissions-modal">&times;</button>
                    </div>
                    <div class="modal-body">
                        <p id="permissions-user-name" style="font-weight: bold; margin-bottom: 10px;"></p>
                        <form id="permissions-form">
                            <div class="form-group">
                                <label><input type="checkbox" name="perm_dashboard" value="graficos"> Dashboard</label>
                            </div>
                            <div class="form-group">
                                <label><input type="checkbox" name="perm_plantio" value="plantio-dia"> Plantio</label>
                            </div>
                            <!-- Sub-abas Plantio -->
                            <div class="form-group" style="margin-left: 20px; border-left: 2px solid #eee; padding-left: 10px;">
                                <label style="font-size: 0.9em; color: #555;"><input type="checkbox" name="perm_sub_plantio" value="sub_plantio"> ‚Ü≥ Plantio de Cana</label>
                            </div>
                            <div class="form-group" style="margin-left: 20px; border-left: 2px solid #eee; padding-left: 10px;">
                                <label style="font-size: 0.9em; color: #555;"><input type="checkbox" name="perm_sub_colheita" value="sub_colheita_muda"> ‚Ü≥ Colheita de Muda</label>
                            </div>
                            <div class="form-group" style="margin-left: 20px; border-left: 2px solid #eee; padding-left: 10px;">
                                <label style="font-size: 0.9em; color: #555;"><input type="checkbox" name="perm_sub_qualidade" value="sub_qualidade_muda"> ‚Ü≥ Qualidade de Muda</label>
                            </div>
                            <div class="form-group">
                                <label><input type="checkbox" name="perm_viagens" value="viagens-adubo"> Viagens Adubo</label>
                            </div>
                            <!-- Sub-abas Viagens Adubo -->
                            <div class="form-group" style="margin-left: 20px; border-left: 2px solid #eee; padding-left: 10px;">
                                <label style="font-size: 0.9em; color: #555;"><input type="checkbox" name="perm_sub_viagem_adubo" value="sub_viagem_adubo"> ‚Ü≥ Transporte de Adubo</label>
                            </div>
                            <div class="form-group" style="margin-left: 20px; border-left: 2px solid #eee; padding-left: 10px;">
                                <label style="font-size: 0.9em; color: #555;"><input type="checkbox" name="perm_sub_viagem_composto" value="sub_viagem_composto"> ‚Ü≥ Transporte de Composto</label>
                            </div>
                            <div class="form-group">
                                <label><input type="checkbox" name="perm_insumos" value="insumos-fazendas"> Insumos</label>
                            </div>
                            <div class="form-group">
                                <label><input type="checkbox" name="perm_estoque" value="estoque"> Estoque</label>
                            </div>

                            <div style="margin-top: 15px; display: flex; justify-content: flex-end; gap: 10px;">
                                <button type="button" class="btn btn-secondary close-permissions-modal">Cancelar</button>
                                <button type="submit" class="btn btn-primary">Salvar Permiss√µes</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>

            <!-- Container para Relat√≥rio Avan√ßado de Impress√£o -->
            <div id="report-print-container" class="print-only"></div>

            
            <div class="tabs">
                <button class="tab active" data-tab="graficos">üìà Dashboard</button>
                <button class="tab" data-tab="plantio-dia">üìÖ Plantio</button>
                <button class="tab" data-tab="viagens-adubo">üöö Viagens Adubo</button>
                <button class="tab" data-tab="insumos-fazendas">üå± Insumos</button>
                <button class="tab" data-tab="estoque">üì¶ Estoque</button>
            </div>

            <!-- Conte√∫do das Tabs -->
            <div class="content-area">

        <!-- Tab DASHBOARD -->
        <div class="tab-content active" id="graficos">
            <div class="dashboard-header">
                <div class="filters">
                    <div class="filter-group">
                        <label for="dashboard-periodo">Per√≠odo:</label>
                        <select id="dashboard-periodo">
                            <option value="30">√öltimos 30 dias</option>
                            <option value="90">√öltimos 90 dias</option>
                            <option value="365">√öltimo Ano</option>
                            <option value="all" selected>Todo o Per√≠odo</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label for="dashboard-fazenda">Fazenda:</label>
                        <select id="dashboard-fazenda">
                            <option value="all">Todas as Fazendas</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label for="dashboard-produto">Produto:</label>
                        <select id="dashboard-produto">
                            <option value="all">Todos os Produtos</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label for="dashboard-frente">Frente:</label>
                        <select id="dashboard-frente">
                            <option value="all">Todas as Frentes</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label for="charts-order-select">Ordena√ß√£o:</label>
                        <select id="charts-order-select">
                            <option value="az">A ‚Üí Z</option>
                            <option value="za">Z ‚Üí A</option>
                            <option value="max">Maior Primeiro</option>
                        </select>
                    </div>
                    <button id="btn-refresh-dashboard" class="btn btn-primary">üîÑ Atualizar Dados</button>
                    <button id="btn-config-metas" class="btn btn-secondary">‚öôÔ∏è Metas</button>
                    <button id="btn-print-report" class="btn btn-secondary" style="background-color: #607D8B; color: white;">üñ®Ô∏è Imprimir Relat√≥rio</button>
                </div>
            </div>

            <!-- √Årea de Relat√≥rio (Vis√≠vel apenas na impress√£o) -->
            <!-- Substitu√≠do por container avan√ßado -->
            
            <!-- KPIs (Indicadores Chave) -->
            <div class="kpi-grid">
                <div class="kpi-card">
                    <div class="kpi-icon">üöú</div>
                    <div class="kpi-info">
                        <span class="kpi-label">√Årea Plantada (Total)</span>
                        <span class="kpi-value" id="kpi-area-plantada">0 ha</span>
                    </div>
                </div>
                <div class="kpi-card">
                    <div class="kpi-icon">üåæ</div>
                    <div class="kpi-info">
                        <span class="kpi-label">√Årea Colhida (Total)</span>
                        <span class="kpi-value" id="kpi-area-colhida">0 ha</span>
                    </div>
                </div>
                <div class="kpi-card">
                    <div class="kpi-icon">üìä</div>
                    <div class="kpi-info">
                        <span class="kpi-label">Colheita / Plantio</span>
                        <span class="kpi-value" id="kpi-colheita-plantio">0</span>
                    </div>
                </div>
                <div class="kpi-card">
                    <div class="kpi-icon">üìã</div>
                    <div class="kpi-info">
                        <span class="kpi-label">OS Ativas</span>
                        <span class="kpi-value" id="kpi-os-ativas">0</span>
                    </div>
                </div>
                <div class="kpi-card">
                    <div class="kpi-icon">üìâ</div>
                    <div class="kpi-info">
                        <span class="kpi-label">Efici√™ncia M√©dia</span>
                        <span class="kpi-value" id="kpi-eficiencia">0%</span>
                    </div>
                </div>
                <div class="kpi-card">
                    <div class="kpi-icon">üöö</div>
                    <div class="kpi-info">
                        <span class="kpi-label">Viagens Adubo</span>
                        <span class="kpi-value" id="kpi-viagens-total">0</span>
                    </div>
                </div>
                <div class="kpi-card">
                    <div class="kpi-icon">üì¶</div>
                    <div class="kpi-info">
                        <span class="kpi-label">Produtos em Estoque</span>
                        <span class="kpi-value" id="kpi-estoque-items">0</span>
                    </div>
                </div>
                <div class="kpi-card">
                    <div class="kpi-icon">üèóÔ∏è</div>
                    <div class="kpi-info">
                        <span class="kpi-label">Vol. Transportado</span>
                        <span class="kpi-value" id="kpi-volume-total">0 t</span>
                    </div>
                </div>
                <!-- Novos KPIs -->
                <div class="kpi-card">
                    <div class="kpi-icon">üíß</div>
                    <div class="kpi-info">
                        <span class="kpi-label">Insumos Aplicados</span>
                        <span class="kpi-value" id="kpi-insumos-total">0 L/kg</span>
                    </div>
                </div>
                 <div class="kpi-card">
                    <div class="kpi-icon">‚úÖ</div>
                    <div class="kpi-info">
                        <span class="kpi-label">OS Conclu√≠das</span>
                        <span class="kpi-value" id="kpi-os-concluidas">0</span>
                    </div>
                </div>
                <!-- KPIs Adicionais -->
                <div class="kpi-card">
                    <div class="kpi-icon">üöõ</div>
                    <div class="kpi-info">
                        <span class="kpi-label">Vol. Composto</span>
                        <span class="kpi-value" id="kpi-volume-composto">0 t</span>
                    </div>
                </div>
                <div class="kpi-card">
                    <div class="kpi-icon">üîì</div>
                    <div class="kpi-info">
                        <span class="kpi-label">√Årea Liberada</span>
                        <span class="kpi-value" id="kpi-area-liberada">0 ha</span>
                    </div>
                </div>
            </div>

            <div class="charts">
                <!-- Linha 1: Plantio e Progresso Geral -->
                <div class="chart-card wide">
                    <h4 style="margin: 0 0 10px 0;">Plantio Di√°rio: Realizado vs Meta (ha)</h4>
                    <div class="filters" style="margin-bottom: 10px;">
                        <label for="plantio-chart-frente">Filtrar Frente:</label>
                        <select id="plantio-chart-frente">
                            <option value="all">Todas as Frentes</option>
                        </select>
                    </div>
                    <canvas id="chart-plantio-diario"></canvas>
                </div>
                
                <div class="chart-card">
                    <h4>Progresso por Fazenda (%)</h4>
                    <canvas id="chart-fazenda-progresso"></canvas>
                </div>

                <!-- Linha 2: OS e Log√≠stica -->
                <div class="chart-card">
                    <h4>Status das Ordens de Servi√ßo</h4>
                    <canvas id="chart-os-status"></canvas>
                </div>

                <div class="chart-card">
                    <h4>Log√≠stica: Viagens Di√°rias</h4>
                    <canvas id="chart-viagens-diarias"></canvas>
                </div>

                <!-- Linha Nova: Composto e Libera√ß√£o -->
                <div class="chart-card">
                    <h4>Transporte Composto Di√°rio</h4>
                    <canvas id="chart-transporte-composto"></canvas>
                </div>
                <div class="chart-card">
                    <h4>Status Libera√ß√£o Colheita</h4>
                    <canvas id="chart-liberacao-status"></canvas>
                </div>

                <!-- Linha 3: Insumos e Estoque -->
                <div class="chart-card">
                    <h4>Comparativo de Insumos (Geral)</h4>
                    <canvas id="chart-dose-global"></canvas>
                </div>

                <div class="chart-card wide">
                    <h4>N√≠veis de Estoque por Frente</h4>
                     <div class="filters" style="margin-bottom: 10px;">
                         <label for="estoque-chart-frente">Frente:</label>
                         <select id="estoque-chart-frente">
                             <option value="all">Geral</option>
                         </select>
                     </div>
                    <canvas id="chart-estoque-geral"></canvas>
                </div>
                
                <div class="chart-card wide">
                    <h4>Evolu√ß√£o Di√°ria de Aplica√ß√£o de Insumos</h4>
                    <canvas id="chart-insumos-evolucao"></canvas>
                </div>

                <!-- Linha 4: Detalhes Insumos -->
                <div class="chart-card">
                     <h4>Diferen√ßa por Produto (%)</h4>
                     <canvas id="chart-diff-produtos"></canvas>
                </div>
                <div class="chart-card">
                    <h4>Compara√ß√£o por Produto</h4>
                    <canvas id="chart-dose-produtos"></canvas>
                </div>

                <!-- Linha 5: Qualidade Operacional -->
                <div class="chart-card wide">
                    <h4>Ranking de Operadores (Qualidade da Muda - % Boas)</h4>
                    <canvas id="chart-ranking-operadores"></canvas>
                </div>
            </div>
        </div>

        <!-- Tab INSUMOS AGR√çCOLAS -->
        <div class="tab-content" id="insumos-fazendas">
            <!-- Filtros INSUMOS FAZENDAS -->
            <div class="filters">
                <div class="filter-group">
                    <label for="produto-filter">Produto:</label>
                    <select id="produto-filter">
                        <option value="all">Todos os Produtos</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label for="fazenda-insumos-filter">Fazenda:</label>
                    <select id="fazenda-insumos-filter">
                        <option value="all">Todas as Fazendas</option>
                    </select>
                </div>
                <button id="apply-insumos-filters" class="btn btn-primary">üîç Aplicar Filtros</button>
                <button id="reset-insumos-filters" class="btn btn-secondary">üîÑ Limpar</button>
            </div>

            

            <!-- Charts movidos para aba separada -->

            <!-- Tabela INSUMOS FAZENDAS -->
            <div class="table-container">
                <table id="insumos-table" class="data-table">
                    <thead>
                        <tr>
                            <th>OS</th>
                            <th>C√≥digo</th>
                            <th>Fazenda</th>
                            <th>√Årea Talh√£o (ha)</th>
                            <th>√Årea Aplicada (ha)</th>
                            <th>Produto</th>
                            <th>Dose Recom.</th>
                            <th>Dose Aplicada</th>
                            <th>Quantidade</th>
                            <th>Diferen√ßa</th>
                            <th>Frente</th>
                            <th>In√≠cio</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td colspan="13" class="loading">üì° Carregando dados...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
            <div class="dashboard-wrapper">
                <div class="chart-card full-width">
                    <h4 style="margin: 0 0 15px 0; border-bottom: 1px solid var(--border); padding-bottom: 10px;">Resumo por Fazenda e Produto</h4>
                    <div class="table-container">
                        <table id="insumos-resumo-table" class="data-table">
                            <thead>
                                <tr>
                                    <th>Fazenda</th>
                                    <th>Produto</th>
                                    <th>√Årea Aplicada (ha)</th>
                                    <th>Dose Recomendada</th>
                                    <th>Dose Aplicada</th>
                                    <th>Quantidade</th>
                                    <th>Diferen√ßa</th>
                                </tr>
                            </thead>
                            <tbody id="insumos-resumo-tbody">
                                <tr>
                                    <td colspan="7" class="loading">üì° Carregando resumo...</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
                <div class="chart-card full-width">
                    <h4 style="margin: 0 0 15px 0; border-bottom: 1px solid var(--border); padding-bottom: 10px;">Comparativo Aplicado vs Previsto</h4>
                    <canvas id="chart-insumos-resumo"></canvas>
                </div>
            </div>
        </div>

    <!-- Loading -->
    <div id="loading" class="loading-overlay">
        <div class="loading-spinner">‚è≥</div>
        <p>Carregando...</p>
    </div>

    <!-- Notifica√ß√£o -->
    <div id="notification" class="notification"></div>

    <!-- Modal para Adicionar/Editar Insumo -->
    <div id="insumo-modal" class="modal" style="display: none;">
        <div class="modal-content" style="max-width: 600px;">
            <div class="modal-header">
                <h3 id="insumo-modal-title">‚ûï Adicionar Insumo</h3>
                <button class="close-modal close-insumo-modal">&times;</button>
            </div>
            <div class="modal-body">
                <form id="insumo-form">
                    <div class="form-grid">
                        <div class="form-group">
                            <label for="fornecedor">Fornecedor *</label>
                            <select id="fornecedor" name="fornecedor" required>
                                <option value="insumosFazendas" selected>INSUMOS FAZENDAS</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label for="os">N√∫mero da OS</label>
                            <input type="number" id="os" name="os" step="1">
                        </div>

                        <div class="form-group">
                            <label for="cod">C√≥digo da Fazenda</label>
                            <input type="number" id="cod" name="cod" step="1">
                        </div>

                        <div class="form-group">
                            <label for="produto">Produto *</label>
                            <select id="produto" name="produto" required>
                                <option value="">Selecione</option>
                                <option>BIOZYME</option>
                                <option>04-30-10</option>
                                <option>QUALITY</option>
                                <option>AZOKOP</option>
                                <option>SURVEY (FIPRONIL)</option>
                                <option>OXIFERTIL</option>
                                <option>LANEX 800 WG (REGENTE)</option>
                                <option>COMET</option>
                                <option>COMPOSTO</option>
                                <option>10-49-00</option>
                                <option>PEREGRINO</option>
                                <option>NO-NEMA</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label for="fazenda">Fazenda *</label>
                            <input type="text" id="fazenda" name="fazenda" required>
                        </div>
                        
                        <div class="form-group">
                            <label for="frente">Frente</label>
                            <input type="number" id="frente" name="frente" step="1">
                        </div>
                        
                        <div class="form-group">
                            <label for="processo">Processo</label>
                            <input type="text" id="processo" name="processo" value="CANA DE ACUCAR">
                        </div>
                        
                        <div class="form-group">
                            <label for="subprocesso">Subprocesso</label>
                            <input type="text" id="subprocesso" name="subprocesso" value="PLANTIO">
                        </div>
                        
                        <div class="form-group">
                            <label for="areaTalhao">√Årea Talh√£o (ha)</label>
                            <input type="number" id="areaTalhao" name="areaTalhao" step="0.01">
                        </div>
                        
                        <div class="form-group">
                            <label for="areaTotalAplicada">√Årea Total Aplicada (ha)</label>
                            <input type="number" id="areaTotalAplicada" name="areaTotalAplicada" step="0.01">
                        </div>
                        
                        <div class="form-group">
                            <label for="doseRecomendada">Dose Recomendada</label>
                            <input type="number" id="doseRecomendada" name="doseRecomendada" step="0.001">
                        </div>

                        <div class="form-group">
                            <label for="doseAplicada">Dose Aplicada</label>
                            <input type="number" id="doseAplicada" name="doseAplicada" step="0.001">
                        </div>

                        <div class="form-group">
                            <label for="quantidadeAplicada">Quantidade Aplicada</label>
                            <input type="number" id="quantidadeAplicada" name="quantidadeAplicada" step="0.000001">
                        </div>

                        <div class="form-group">
                            <label for="dataInicio">Data In√≠cio da Aplica√ß√£o</label>
                            <input type="datetime-local" id="dataInicio" name="dataInicio">
                        </div>

                        
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" id="cancel-insumo">Cancelar</button>
                <button type="button" class="btn btn-primary" id="save-insumo">üíæ Salvar Insumo</button>
            </div>
        </div>
    </div>

    <!-- Tab de Estoque -->
    <div class="tab-content" id="estoque">
        <div class="filters">
            <div class="filter-group">
                <label for="estoque-frente-filter">Frente:</label>
                <select id="estoque-frente-filter">
                    <option value="all">Todas as Frentes</option>
                </select>
            </div>
            <div class="filter-group">
                <label for="estoque-produto-filter">Produto:</label>
                <input type="text" id="estoque-produto-filter" placeholder="Filtrar produto...">
            </div>
            <button id="btn-sync-estoque" class="btn btn-secondary" style="margin-left: auto;">üîÑ Sincronizar com OSs</button>
        </div>
        <div class="dashboard-wrapper">
            <div class="chart-card full-width">
                <h4 style="margin: 0 0 15px 0; border-bottom: 1px solid var(--border); padding-bottom: 10px;">üìä An√°lise de Estoque</h4>
                <canvas id="chart-estoque-frente"></canvas>
            </div>

            <div class="chart-card form-card full-width">
                <h4 style="margin: 0 0 15px 0; border-bottom: 1px solid var(--border); padding-bottom: 10px;">üìù Lan√ßamento Manual de Estoque</h4>
                <div class="manual-entry-container">
                    <div class="manual-entry-group">
                        <label for="estoque-frente">Frente</label>
                        <select id="estoque-frente">
                            <option value="">Selecione</option>
                        </select>
                    </div>
                    <div class="manual-entry-group">
                        <label for="estoque-os-manual">N¬∫ O.S.</label>
                        <select id="estoque-os-manual">
                            <option value="">Selecione a O.S.</option>
                        </select>
                    </div>
                    <div class="manual-entry-group">
                        <label for="estoque-produto">Produto</label>
                        <select id="estoque-produto">
                            <option value="">Selecione</option>
                            <option>BIOZYME</option>
                            <option>04-30-10</option>
                            <option>QUALITY</option>
                            <option>AZOKOP</option>
                            <option>SURVEY (FIPRONIL)</option>
                            <option>OXIFERTIL</option>
                            <option>LANEX 800 WG (REGENTE)</option>
                            <option>COMET</option>
                            <option>COMPOSTO</option>
                            <option>10-49-00</option>
                            <option>PEREGRINO</option>
                            <option>NO-NEMA</option>
                        </select>
                    </div>
                    <div class="manual-entry-group">
                        <label for="estoque-quantidade">Quantidade</label>
                        <input type="number" id="estoque-quantidade" step="0.000001" placeholder="0.00">
                    </div>
                    <div class="manual-entry-group action-group">
                        <button id="estoque-save-btn" class="btn btn-primary">üíæ Salvar Lan√ßamento</button>
                    </div>
                </div>
            </div>
        </div>

        <div class="table-container">
            <table id="estoque-table" class="data-table">
                <thead>
                    <tr>
                        <th>Data</th>
                        <th>N¬∫ O.S.</th>
                        <th>Frente</th>
                        <th>Produto</th>
                        <th>Quantidade</th>
                        <th>A√ß√µes</th>
                    </tr>
                </thead>
                <tbody id="estoque-table-body"></tbody>
            </table>
        </div>
    </div>

    <!-- Tab Viagens de Adubo -->
    <div class="tab-content" id="viagens-adubo">
        <div class="viagem-type-selector" style="display: flex; gap: 10px; margin-bottom: 15px; justify-content: center;">
            <button type="button" id="btn-type-adubo" class="btn btn-primary type-toggle active" data-type="adubo" style="flex: 1;">Transporte de Adubo</button>
            <button type="button" id="btn-type-composto" class="btn btn-secondary type-toggle" data-type="composto" style="flex: 1;">Transporte de Composto</button>
        </div>

        <!-- View ADUBO -->
        <div id="view-adubo-mode">
            <!-- Header e Bot√µes (Novo Layout Padronizado) -->
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding: 15px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);" class="header-container-theme">
                <h4 style="margin:0;">Gerenciamento de Transporte de Adubo</h4>
                <div style="display:flex; gap:10px;">
                     <button id="btn-nova-viagem-adubo" class="btn btn-primary">‚ûï Nova Viagem</button>
                     <button id="btn-toggle-viagens-filters" class="btn btn-secondary">üîç Filtrar</button>
                     <button id="btn-export-resumo-executivo" class="btn btn-secondary">üìÑ Resumo Executivo (PDF)</button>
                </div>
            </div>

        <div id="viagens-filters-container" class="filters" style="display: none;">
            <div class="filter-group">
                <label for="viagens-tipo-filter">Tipo</label>
                <select id="viagens-tipo-filter">
                    <option value="">Todos</option>
                    <option value="adubo">Adubo</option>
                    <option value="composto">Composto</option>
                </select>
            </div>
            <div class="filter-group">
                <label for="viagens-data-filter">Data</label>
                <input type="date" id="viagens-data-filter">
            </div>
            <div class="filter-group">
                <label for="viagens-fazenda-filter">Fazenda</label>
                <select id="viagens-fazenda-filter">3
                    <option value="">Todas as Fazendas</option>
                </select>
            </div>
            <div class="filter-group">
                <label for="viagens-frente-filter">Frente</label>
                <input type="text" id="viagens-frente-filter" placeholder="Ex.: 4001">
            </div>
            <div class="filter-group">
                <label for="viagens-motorista-filter">Motorista</label>
                <input type="text" id="viagens-motorista-filter" placeholder="Nome do motorista">
            </div>
            <div class="filter-group">
                <label for="viagens-caminhao-filter">Caminh√£o</label>
                <input type="text" id="viagens-caminhao-filter" placeholder="Placa ou identifica√ß√£o">
            </div>
            <div class="filter-group">
                <label for="viagens-lacre-filter">Lacre</label>
                <input type="text" id="viagens-lacre-filter" placeholder="Lacre do bag">
            </div>
            <button id="apply-viagens-filters" class="btn btn-primary">üîç Aplicar Filtros</button>
            <button id="reset-viagens-filters" class="btn btn-secondary">üîÑ Limpar</button>
        </div>

        <div class="dashboard-wrapper" id="new-viagem-container" style="display: none;">
            <div class="chart-card form-card">
                <h4 style="margin: 0 0 10px 0;">Cadastro de Viagem</h4>
                <div class="form-grid boletim-grid">
                    <div class="form-group">
                        <label for="viagem-data">Data</label>
                        <input type="date" id="viagem-data">
                    </div>
                    <!-- Campo OS para Adubo -->
                    <div class="form-group adubo-field">
                        <label for="viagem-adubo-os">N√∫mero da OS</label>
                        <input type="number" id="viagem-adubo-os" placeholder="N√∫mero da OS" step="1">
                    </div>
                    <div class="form-group adubo-field">
                        <label for="viagem-frente">Frente</label>
                        <input type="text" id="viagem-frente" placeholder="Ex.: 4001">
                    </div>
                    <div class="form-group">
                        <label for="viagem-codigo-fazenda">C√≥digo</label>
                        <input type="number" id="viagem-codigo-fazenda" placeholder="C√≥d">
                    </div>
                    <div class="form-group">
                        <label for="viagem-fazenda">Fazenda</label>
                        <select id="viagem-fazenda">
                            <option value="">Selecione a Fazenda</option>
                        </select>
                    </div>
                    <div class="form-group adubo-field">
                        <label for="viagem-origem">Origem</label>
                        <input type="text" id="viagem-origem" placeholder="Ex.: Armaz√©m A">
                    </div>
                    <div class="form-group adubo-field">
                        <label for="viagem-destino">Destino</label>
                        <input type="text" id="viagem-destino" placeholder="Ex.: Talh√£o 1">
                    </div>
                    <div class="form-group">
                        <label for="viagem-produto">Produto</label>
                        <select id="viagem-produto">
                            <option value="">Selecione</option>
                            <option>BIOZYME</option>
                            <option>04-30-10</option>
                            <option>QUALITY</option>
                            <option>AZOKOP</option>
                            <option>SURVEY (FIPRONIL)</option>
                            <option>OXIFERTIL</option>
                            <option>LANEX 800 WG (REGENTE)</option>
                            <option>COMET</option>
                            <option>COMPOSTO</option>
                            <option>10-49-00</option>
                            <option>PEREGRINO</option>
                            <option>NO-NEMA</option>
                            <option value="Outro">Outro</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="viagem-quantidade-total">Quantidade (t)</label>
                        <input type="number" id="viagem-quantidade-total" step="0.001">
                    </div>
                    <div class="form-group adubo-field">
                        <label for="viagem-unidade">Unidade</label>
                        <select id="viagem-unidade">
                            <option value="">Selecione</option>
                            <option value="t">t</option>
                            <option value="kg">kg</option>
                            <option value="L">L</option>
                            <option value="sc">sc</option>
                            <option value="bag">bag</option>
                        </select>
                    </div>
                    <div class="form-group adubo-field">
                        <label for="viagem-caminhao">Caminh√£o</label>
                        <input type="text" id="viagem-caminhao" placeholder="Placa / identifica√ß√£o">
                    </div>
                    <div class="form-group adubo-field">
                        <label for="viagem-carreta1">Carreta 1</label>
                        <input type="text" id="viagem-carreta1" placeholder="Opcional">
                    </div>
                    <div class="form-group adubo-field">
                        <label for="viagem-carreta2">Carreta 2</label>
                        <input type="text" id="viagem-carreta2" placeholder="Opcional">
                    </div>
                    <div class="form-group adubo-field">
                        <label for="viagem-motorista">Motorista</label>
                        <input type="text" id="viagem-motorista">
                    </div>
                    <div class="form-group adubo-field">
                        <label for="viagem-documento-motorista">Doc. Motorista</label>
                        <input type="text" id="viagem-documento-motorista" placeholder="CPF / CNH">
                    </div>
                    <div class="form-group adubo-field">
                        <label for="viagem-transportadora">Transportadora</label>
                        <input type="text" id="viagem-transportadora">
                    </div>
                    <div class="form-group">
                        <label for="viagem-observacoes">Observa√ß√µes</label>
                        <input type="text" id="viagem-observacoes" placeholder="Opcional">
                    </div>
                    
                    <!-- Campos espec√≠ficos de Transporte de Composto -->
                    <div class="form-group composto-field" style="display:none;">
                        <label for="viagem-os">N¬∫ O.S.</label>
                        <input type="number" id="viagem-os" placeholder="N√∫mero da OS">
                    </div>
                    <div class="form-group composto-field" style="display:none;">
                        <label for="viagem-abertura-os">Abertura O.S.</label>
                        <input type="date" id="viagem-abertura-os">
                    </div>
                    <div class="form-group composto-field" style="display:none;">
                        <label for="viagem-fechamento-os">Fechamento O.S.</label>
                        <input type="date" id="viagem-fechamento-os">
                    </div>
                    <div class="form-group composto-field" style="display:none;">
                        <label for="viagem-previsto">Total Previsto (t)</label>
                        <input type="number" id="viagem-previsto" step="0.001">
                    </div>
                    <div class="form-group composto-field" style="display:none;">
                        <label for="viagem-realizado">Total Realizado (t)</label>
                        <input type="number" id="viagem-realizado" step="0.001">
                    </div>
                </div>
                <div style="margin-top:10px; display:flex; gap:10px;">
                    <button id="viagem-save-btn" class="btn btn-primary">üíæ Registrar Viagem</button>
                </div>
            </div>

            <div class="chart-card form-card" id="viagem-bags-section">
                <h4 style="margin: 0 0 10px 0;">Bags da Viagem</h4>
                <div class="form-grid boletim-grid">
                    <div class="form-group">
                        <label for="bag-identificacao">Identifica√ß√£o</label>
                        <input type="text" id="bag-identificacao" placeholder="Ex.: BAG 001">
                    </div>
                    <div class="form-group">
                        <label for="bag-peso">Peso</label>
                        <input type="number" id="bag-peso" step="0.001">
                    </div>
                    <div class="form-group">
                        <label for="bag-lacre">Lacre</label>
                        <input type="text" id="bag-lacre" placeholder="Lacre / selo">
                    </div>
                    <div class="form-group">
                        <label for="bag-observacoes">Observa√ß√µes</label>
                        <input type="text" id="bag-observacoes" placeholder="Opcional">
                    </div>
                </div>
                <div style="margin-top:10px; display:flex; gap:10px;">
                    <button id="bag-add-btn" class="btn btn-secondary">‚ûï Adicionar Bag</button>
                </div>
                <div class="table-container" style="margin-top:10px;">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Identifica√ß√£o</th>
                                <th>Peso</th>
                                <th>Lacre</th>
                                <th>Observa√ß√µes</th>
                                <th>A√ß√µes</th>
                            </tr>
                        </thead>
                        <tbody id="bags-table-body"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <div class="table-container">
            <table class="data-table" id="viagens-adubo-table">
                <thead>
                    <tr>
                        <th>Data</th>
                        <th>Frente</th>
                        <th>Fazenda</th>
                        <th>Produto</th>
                        <th>Quantidade</th>
                        <th>Unidade</th>
                        <th>Motorista</th>
                        <th>Caminh√£o</th>
                        <th>A√ß√µes</th>
                    </tr>
                </thead>
                <tbody id="viagens-adubo-table-body">
                    <tr>
                        <td colspan="10" class="loading">üì° Carregando dados...</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

    <!-- View COMPOSTO (Fixed Layout) -->
    <div id="view-composto-mode" style="display:none;">
        
        <!-- Header e Bot√µes -->
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding: 15px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);" class="header-container-theme">
            <h4 style="margin:0;">Gerenciamento de Transporte de Composto</h4>
            <div style="display:flex; gap:10px;">
                 <button class="btn btn-primary" id="btn-novo-lancamento-composto">‚ûï Novo Transporte (Composto)</button>
                 <input type="file" id="file-import-pdf" accept=".pdf" style="display:none;">
                 <button id="btn-composto-import" class="btn btn-secondary">üìÇ Importar PDF</button>
            </div>
        </div>
        
        <!-- Debug Area for PDF Import -->
        <div id="import-debug-area" style="display:none; margin-bottom: 15px; background: #f8f9fa; padding: 10px; border: 1px solid #ddd; border-radius: 4px;">
            <p id="import-status-msg" style="margin: 0; font-size: 14px; font-weight: bold;"></p>
        </div>

        <!-- Filtros e Tabela -->
        <div class="filters">
             <input type="text" id="composto-search-os" placeholder="Buscar N¬∫ OS..." style="width: 200px;">
             <select id="composto-filter-status">
                <option value="">Todos Status</option>
                <option value="ABERTO">Aberto</option>
                <option value="FECHADO">Fechado</option>
             </select>
             <button id="btn-refresh-composto" class="btn btn-secondary" style="margin-left:auto;">üîÑ Atualizar</button>
        </div>

        <div class="table-container">
            <table class="data-table" id="transporte-composto-table">
                <thead>
                    <tr>
                        <th>OS</th>
                        <th>Data Abertura</th>
                        <th>Fazenda/Frente</th>
                        <th>Produto</th>
                        <th>Meta (t)</th>
                        <th>Restante (t)</th>
                        <th>Status</th>
                        <th style="width: 150px;">A√ß√µes</th>
                    </tr>
                </thead>
                <tbody id="transporte-composto-body">
                    <tr><td colspan="7" class="loading">Selecione "Transporte de Composto" para carregar.</td></tr>
                </tbody>
            </table>
        </div>
    </div>
    </div> <!-- End of tab-content #viagens-adubo -->

    <!-- Tab Plantio Dia -->
    <div class="tab-content" id="plantio-dia">
        <div class="dashboard-wrapper">
             <div class="chart-card" style="height: 80vh; min-height: 500px;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; flex-wrap: wrap; gap: 10px;">
                    <h4 style="margin: 0;">Registros de Plantio Di√°rio</h4>
                    <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                        <button class="btn btn-secondary" id="btn-os">üìã Gerenciar O.S.</button>
                        <button class="btn btn-secondary" id="btn-open-fazendas-modal">üöú Fazendas</button>
                        <button class="btn btn-secondary" id="btn-liberacao-colheita">üåæ Libera√ß√£o Colheita</button>
                        <button class="btn btn-primary" id="btn-novo-lancamento">‚ûï Novo Plantio</button>
                        <button class="btn btn-primary" id="btn-nova-qualidade-muda" style="background-color: #d63384; border-color: #d63384;">üß¨ Nova Qualidade de Muda</button>
                    </div>
                </div>

                <!-- Tabs para separa√ß√£o de tipos -->
                <div class="plantio-tabs-container" style="margin-bottom: 15px; border-bottom: 1px solid #e0e0e0; display: flex; gap: 20px;">
                    <button class="plantio-tab-btn active" data-tab="plantio" style="background: none; border: none; padding: 10px 5px; font-weight: 600; color: var(--text-color); border-bottom: 3px solid transparent; cursor: pointer; font-size: 1rem;">
                        üå± Plantio de Cana
                    </button>
                    <button class="plantio-tab-btn" data-tab="colheita_muda" style="background: none; border: none; padding: 10px 5px; font-weight: 600; color: #666; border-bottom: 3px solid transparent; cursor: pointer; font-size: 1rem;">
                        üåæ Colheita de Muda
                    </button>
                    <button class="plantio-tab-btn" data-tab="qualidade_muda" style="background: none; border: none; padding: 10px 5px; font-weight: 600; color: #666; border-bottom: 3px solid transparent; cursor: pointer; font-size: 1rem;">
                        üß¨ Qualidade de Muda
                    </button>
                </div>

                <div class="table-container" style="flex: 1; overflow-y: auto;">
                    <table class="data-table">
                        <thead id="plantio-table-head">
                            <tr>
                                <th>Data</th>
                                <th>Frentes</th>
                                <th>√Årea Total (ha)</th>
                                <th>A√ß√µes</th>
                            </tr>
                        </thead>
                        <tbody id="plantio-table-body">
                            <tr><td colspan="4" class="loading">Carregando...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Modal Details (Generic) -->
    <div id="import-preview" class="modal" style="display:none;">
        <div class="modal-content">
            <div class="modal-header"><h3>Resultado da Importa√ß√£o</h3><button class="close-modal" onclick="document.getElementById('import-preview').style.display='none'">&times;</button></div>
            <div class="modal-body"><pre id="import-result-json" class="json-preview"></pre></div>
            <div class="modal-footer">
                <button class="btn btn-primary" id="btn-confirm-import">Preencher Formul√°rio</button>
            </div>
        </div>
    </div>

    <div id="modal-produto-outro" class="modal" style="display:none; position: fixed; inset: 0; z-index: 12100;">
        <div class="modal-content" style="max-width: 520px;">
            <div class="modal-header">
                <h3>Produto Outro</h3>
                <button class="close-modal" id="outro-produto-cancel">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-grid">
                    <div class="form-group">
                        <label for="outro-produto-nome">Nome do Produto *</label>
                        <input type="text" id="outro-produto-nome" required>
                    </div>
                    <div class="form-group">
                        <label for="outro-produto-justificativa">Justificativa *</label>
                        <textarea id="outro-produto-justificativa" rows="3" required></textarea>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" id="outro-produto-cancel-btn">Cancelar</button>
                <button class="btn btn-primary" id="outro-produto-confirm">Confirmar</button>
            </div>
        </div>
    </div>


    </div>

    <div id="viagem-detail-modal" class="modal" style="display:none;">
        <div class="modal-content" style="max-width: 700px;">
            <div class="modal-header">
                <h3 id="viagem-detail-title">Detalhes da Viagem</h3>
                <button class="close-modal" id="viagem-detail-close">&times;</button>
            </div>
            <div class="modal-body" id="viagem-detail-body"></div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" id="viagem-detail-cancel">Fechar</button>
                <button type="button" class="btn btn-primary" id="viagem-detail-print">üñ®Ô∏è Imprimir</button>
            </div>
        </div>
    </div>

    <!-- Modal Detalhes do Plantio -->
    <div id="plantio-detail-modal" class="modal" style="display:none;">
        <div class="modal-content" style="max-width: 900px;">
            <div class="modal-header">
                <h3 id="plantio-detail-title">Detalhes do Plantio</h3>
                <button class="close-modal" onclick="document.getElementById('plantio-detail-modal').style.display='none'">&times;</button>
            </div>
            <div class="modal-body" id="plantio-detail-body"></div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="document.getElementById('plantio-detail-modal').style.display='none'">Fechar</button>
                <button type="button" class="btn btn-primary" id="plantio-detail-print-btn">üñ®Ô∏è Imprimir</button>
            </div>
        </div>
    </div>

        
    </div>

    <div id="os-modal" class="modal" style="display: none;">
        <div class="modal-content" style="max-width: 95%;">
            <div class="modal-header">
                <h3>üìã Cadastro de Ordem de Servi√ßo (OS)</h3>
                <button class="close-modal close-os-modal">&times;</button>
            </div>
            <div class="modal-body">
                
                <!-- LISTA DE OS (Vis√£o Principal) -->
                <div id="os-view-list" class="chart-card form-card">
                     <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                        <h4 style="margin: 0;">Todas as OS Cadastradas</h4>
                        <button class="btn btn-primary" id="btn-nova-os">‚ûï Nova OS</button>
                     </div>
                     <div class="table-container">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>N√∫mero</th>
                                    <th>Status</th>
                                    <th>Fazenda</th>
                                    <th>Data Abertura</th>
                                    <th>Respons√°vel</th>
                                    <th>A√ß√µes</th>
                                </tr>
                            </thead>
                            <tbody id="os-list-body">
                                <tr>
                                    <td colspan="6" class="loading">Carregando...</td>
                                </tr>
                            </tbody>
                        </table>
                     </div>
                </div>

                <!-- FORMUL√ÅRIO DE OS (Oculto por padr√£o) -->
                <div id="os-view-form" style="display: none;">
                    <button class="btn btn-secondary" id="btn-voltar-os-list" style="margin-bottom: 10px;">‚¨Ö Voltar para Lista</button>

                    <div class="charts">
                        <div class="chart-card form-card">
                            <h4 style="margin: 0 0 10px 0;">Dados da OS</h4>
                        <div style="margin-bottom: 15px; padding: 10px; background-color: #f5f5f5; border-radius: 4px; display: flex; align-items: center; justify-content: space-between;">
                            <span>Importar dados de arquivo (PDF):</span>
                            <div>
                                <input type="file" id="os-file-input" accept="application/pdf" style="display: none;">
                                <button class="btn btn-secondary" onclick="document.getElementById('os-file-input').click()">üìÇ Selecionar PDF</button>
                            </div>
                        </div>

                        <div class="form-grid boletim-grid">
                            <!-- Cabe√ßalho -->
                            <div class="form-group">
                                <label for="os-numero">N√∫mero da OS</label>
                                <input type="text" id="os-numero">
                            </div>
                            <div class="form-group">
                                <label for="os-status">Status</label>
                                <input type="text" id="os-status">
                            </div>
                            <div class="form-group">
                                <label for="os-data-abertura">Abertura</label>
                                <input type="date" id="os-data-abertura">
                            </div>
                            <div class="form-group">
                                <label for="os-data-inicio">In√≠cio Prev.</label>
                                <input type="date" id="os-data-inicio">
                            </div>
                            <div class="form-group">
                                <label for="os-data-final">Final Prev.</label>
                                <input type="date" id="os-data-final">
                            </div>
                            
                            <!-- Info Principal -->
                            <div class="form-group">
                                <label for="os-resp">Resp. Aplica√ß√£o</label>
                                <input type="text" id="os-resp">
                            </div>
                            <div class="form-group">
                                <label for="os-empresa">Empresa</label>
                                <input type="text" id="os-empresa">
                            </div>
                            <div class="form-group">
                                <label for="os-frente">Frente</label>
                                <input type="text" id="os-frente">
                            </div>
                             <div class="form-group">
                                <label for="os-processo">Processo</label>
                                <input type="text" id="os-processo">
                            </div>
                             <div class="form-group">
                                <label for="os-subprocesso">SubProcesso</label>
                                <input type="text" id="os-subprocesso">
                            </div>
                            
                            <!-- Localiza√ß√£o -->
                             <div class="form-group">
                                <label for="os-cod-fazenda">C√≥d. Fazenda</label>
                                <input type="number" id="os-cod-fazenda" step="1" placeholder="C√≥d.">
                            </div>
                             <div class="form-group">
                                <label for="os-fazenda">Fazenda</label>
                                <input type="text" id="os-fazenda">
                            </div>
                             <div class="form-group">
                                <label for="os-setor">Setor</label>
                                <input type="text" id="os-setor">
                            </div>
                            <div class="form-group">
                                <label for="os-area-total">√Årea Total (ha)</label>
                                <input type="number" id="os-area-total" step="0.01">
                            </div>
                        </div>

                        <!-- Talh√µes -->
                        <h5 style="margin: 15px 0 5px 0;">Talh√µes</h5>
                        <div class="table-container">
                            <table class="data-table">
                                <thead>
                                    <tr>
                                        <th>Talh√£o</th>
                                        <th>√Årea (ha)</th>
                                        <th>Propriet√°rio</th>
                                        <th>Fundo Agr√≠cola</th>
                                    </tr>
                                </thead>
                                <tbody id="os-talhoes-body">
                                    <!-- Preenchido via JS -->
                                </tbody>
                            </table>
                        </div>

                        <!-- Produtos -->
                        <h5 style="margin: 15px 0 5px 0;">Produtos Planejados</h5>
                        <div class="table-container">
                            <table class="data-table">
                                <thead>
                                    <tr>
                                        <th>Produto</th>
                                        <th>Dose Rec.</th>
                                        <th>Unid.</th>
                                        <th>Qtd. Total</th>
                                    </tr>
                                </thead>
                                <tbody id="os-produtos-body">
                                    <!-- Preenchido via JS -->
                                </tbody>
                            </table>
                        </div>

                        <!-- Transporte Di√°rio de Composto (REMOVIDO: Funcionalidade movida para a aba principal de Transporte de Composto) -->
                        <!-- 
                        <h5 style="margin: 15px 0 5px 0; border-top: 1px solid #eee; padding-top: 15px;">Transporte Di√°rio de Composto</h5>
                        <div id="os-transporte-container" style="display:none;">
                            <div class="form-grid" style="grid-template-columns: auto auto auto auto; align-items: end; margin-bottom: 10px;">
                                <div class="form-group">
                                    <label for="os-transporte-data">Data</label>
                                    <input type="date" id="os-transporte-data">
                                </div>
                                <div class="form-group">
                                    <label for="os-transporte-qtd">Qtd. Total (t)</label>
                                    <input type="number" id="os-transporte-qtd" step="0.001">
                                </div>
                                <div class="form-group">
                                    <label for="os-transporte-frota">Frota</label>
                                    <input type="text" id="os-transporte-frota" placeholder="Ex: Caminh√£o X, Trator Y">
                                </div>
                                <button type="button" class="btn btn-secondary" id="btn-add-os-transporte">Adicionar</button>
                            </div>

                            <div class="table-container">
                                <table class="data-table">
                                    <thead>
                                        <tr>
                                            <th>Data</th>
                                            <th>Quantidade (t)</th>
                                            <th>Frota</th>
                                            <th>A√ß√µes</th>
                                        </tr>
                                    </thead>
                                    <tbody id="os-transporte-body">
                                        
                                    </tbody>
                                    <tfoot>
                                        <tr>
                                            <th>Total</th>
                                            <th id="os-transporte-total-qtd">0.000</th>
                                            <th colspan="2"></th>
                                        </tr>
                                    </tfoot>
                                </table>
                            </div>
                        </div>
                        <div id="os-transporte-warning" style="color: #666; font-style: italic; padding: 10px; background: #f9f9f9; border-radius: 4px;">
                            Salve a OS primeiro para habilitar os lan√ßamentos de transporte.
                        </div>
                        -->

                        <div style="margin-top:20px;display:flex;gap:10px;justify-content:flex-end;">
                            <button type="button" class="btn btn-secondary" id="os-novo">Limpar</button>
                            <button type="button" class="btn btn-primary" id="os-save">üíæ Salvar OS</button>
                        </div>
                    </div>
                </div>
            </div> <!-- Fim de os-view-form -->
            </div> <!-- Fim de modal-body -->
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary close-os-modal">Fechar</button>
            </div>
        </div>
    </div>

    <!-- Modal Cadastro Fazendas -->
    <div id="fazendas-modal" class="modal" style="display: none;">
        <div class="modal-content" style="max-width: 95%;">
            <div class="modal-header">
                <h3>üè° Gerenciar Fazendas</h3>
                <button class="close-modal close-fazendas-modal">&times;</button>
            </div>
            <div class="modal-body">
                <div class="charts">
                    <div class="chart-card form-card">
                        <h4 style="margin: 0 0 10px 0;">Cadastro de Fazendas</h4>
                        <div class="form-grid">
                            <div class="form-group">
                                <label for="cadastro-fazenda-codigo">C√≥digo da Fazenda</label>
                                <input type="number" id="cadastro-fazenda-codigo" step="1">
                            </div>
                            <div class="form-group">
                                <label for="cadastro-fazenda-nome">Nome</label>
                                <input type="text" id="cadastro-fazenda-nome">
                            </div>
                            <div class="form-group">
                                <label for="cadastro-fazenda-regiao">C√≥digo da Regi√£o</label>
                                <input type="text" id="cadastro-fazenda-regiao">
                            </div>
                            <div class="form-group">
                                <label for="cadastro-fazenda-area-total">√Årea total (ha)</label>
                                <input type="number" id="cadastro-fazenda-area-total" step="0.01">
                            </div>
                            <div class="form-group">
                                <label for="cadastro-fazenda-plantio-acumulado">Plantio acumulado (ha)</label>
                                <input type="number" id="cadastro-fazenda-plantio-acumulado" step="0.01" readonly>
                            </div>
                            <div class="form-group">
                                <label for="cadastro-fazenda-muda-acumulada">Muda acumulada</label>
                                <input type="number" id="cadastro-fazenda-muda-acumulada" step="0.01" readonly>
                            </div>
                            <div class="form-group" style="grid-column: span 3;">
                                <label for="cadastro-fazenda-observacoes">Observa√ß√µes</label>
                                <input type="text" id="cadastro-fazenda-observacoes">
                            </div>
                        </div>
                        <div style="margin-top:10px;display:flex;gap:10px;justify-content:flex-end;">
                            <button type="button" class="btn btn-secondary" id="cadastro-fazenda-novo">Novo</button>
                            <button type="button" class="btn btn-primary" id="cadastro-fazenda-save">üíæ Salvar Fazenda</button>
                            <button type="button" class="btn btn-secondary" id="cadastro-fazenda-import-pdf">üì• Importar PDF Fazendas</button>
                            <input type="file" id="cadastro-fazenda-pdf-input" accept="application/pdf" style="display:none">
                        </div>
                    </div>
                    <div class="chart-card form-card">
                        <h4 style="margin: 0 0 10px 0;">Fazendas Cadastradas</h4>
                        <div class="table-container">
                            <table id="cadastro-fazendas-table" class="data-table">
                                <thead>
                                    <tr>
                                        <th>C√≥digo da Fazenda</th>
                                        <th>Nome</th>
                                        <th>C√≥digo da Regi√£o</th>
                                        <th>√Årea total (ha)</th>
                                        <th>Plantio acumulado (ha)</th>
                                        <th>Muda acumulada</th>
                                        <th>A√ß√µes</th>
                                    </tr>
                                </thead>
                                <tbody id="cadastro-fazendas-body">
                                    <tr>
                                        <td colspan="7" class="loading">üì° Carregando cadastro de fazendas...</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary close-fazendas-modal">Fechar</button>
            </div>
        </div>
    </div>

    <div id="fazenda-import-modal" class="modal" style="display:none;">
        <div class="modal-content" style="max-width: 700px;">
            <div class="modal-header">
                <h3>üì• Importar Fazendas via PDF</h3>
                <button class="close-modal" id="fazenda-import-close">&times;</button>
            </div>
            <div class="modal-body">
                <div id="fazenda-import-preview"></div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" id="fazenda-import-cancel">Cancelar</button>
                <button type="button" class="btn btn-primary" id="fazenda-import-confirm">üöÄ Importar</button>
            </div>
        </div>
    </div>

    <!-- Modal de Configura√ß√£o de Metas -->
    <div id="metas-modal" class="modal" style="display: none;">
        <div class="modal-content" style="max-width: 600px;">
            <div class="modal-header">
                <h3>‚öôÔ∏è Configurar Metas de Plantio</h3>
                <button class="close-modal close-metas-modal">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-grid" style="grid-template-columns: 1fr 1fr auto; align-items: end;">
                    <div class="form-group">
                        <label for="meta-frente">Frente</label>
                        <select id="meta-frente">
                            <option value="">Selecione a Frente...</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="meta-valor">Meta Di√°ria (ha)</label>
                        <input type="number" id="meta-valor" step="0.01" placeholder="0.00">
                    </div>
                    <div class="form-group">
                        <button id="btn-save-meta" class="btn btn-primary">üíæ Salvar</button>
                    </div>
                </div>

                <hr style="margin: 20px 0; border: 0; border-top: 1px solid #eee;">

                <h4>Metas Definidas</h4>
                <div class="table-container">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Frente</th>
                                <th>Meta Di√°ria (ha)</th>
                            </tr>
                        </thead>
                        <tbody id="metas-table-body">
                            <!-- Preenchido via JS -->
                        </tbody>
                    </table>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary close-metas-modal">Fechar</button>
            </div>
        </div>
    </div>

    <div id="progress-modal" class="modal" style="display:none; z-index: 2000;">
        <div class="modal-content" style="max-width: 400px; text-align: center;">
            <h3 id="progress-title" style="margin-top:0;">Processando...</h3>
            <div style="width: 100%; background-color: #e0e0e0; border-radius: 8px; margin: 20px 0; overflow: hidden;">
                <div id="progress-bar" style="width: 0%; height: 24px; background-color: #4CAF50; transition: width 0.3s ease;"></div>
            </div>
            <p id="progress-text" style="font-weight: bold; color: #555;">0%</p>
        </div>
    </div>

    <!-- Modal Libera√ß√£o de Colheita -->
    <div id="liberacao-modal" class="modal" style="display: none;">
        <div class="modal-content" style="max-width: 90%;">
            <div class="modal-header">
                <h3>üåæ Libera√ß√£o de Colheita de Muda</h3>
                <button class="close-modal close-liberacao-modal">&times;</button>
            </div>
            <div class="modal-body">
                
                <!-- LIST VIEW -->
                <div id="liberacao-view-list">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                        <h4 style="margin:0;">Libera√ß√µes Cadastradas</h4>
                        <button class="btn btn-primary" id="btn-nova-liberacao">‚ûï Nova Libera√ß√£o</button>
                    </div>
                    <div class="table-container">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>N√∫mero</th>
                                    <th>Data</th>
                                    <th>Frente</th>
                                    <th>Fazenda</th>
                                    <th>Status</th>
                                    <th>A√ß√µes</th>
                                </tr>
                            </thead>
                            <tbody id="liberacao-list-body">
                                <tr><td colspan="6" class="loading">Carregando...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- FORM VIEW -->
                <div id="liberacao-view-form" style="display:none;">
                    <button class="btn btn-secondary" id="btn-voltar-liberacao-list" style="margin-bottom: 15px;">‚¨Ö Voltar para Lista</button>

                    <form id="liberacao-form">
                        <div class="form-grid">
                            <div class="form-group">
                                <label for="liberacao-numero">N√∫mero Libera√ß√£o</label>
                                <input type="text" id="liberacao-numero" placeholder="N¬∫ Libera√ß√£o" required>
                            </div>
                            <div class="form-group">
                                <label for="liberacao-data">Data</label>
                                <input type="date" id="liberacao-data" required>
                            </div>
                            <div class="form-group">
                                <label for="liberacao-frente">Frente (OS)</label>
                                <select id="liberacao-frente" required>
                                    <option value="">Selecione...</option>
                                    <!-- Populated via JS -->
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="liberacao-fazenda">Fazenda</label>
                                <select id="liberacao-fazenda" required>
                                    <option value="">Selecione a Fazenda...</option>
                                    <!-- Populated via JS -->
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="liberacao-cod-fazenda">C√≥d. Fazenda</label>
                                <input type="text" id="liberacao-cod-fazenda" readonly style="background: #f0f0f0;">
                            </div>
                            <div class="form-group">
                                <label for="liberacao-status">Status</label>
                                <select id="liberacao-status">
                                    <option value="Aberto">Aberto</option>
                                    <option value="Fechado">Fechado</option>
                                </select>
                            </div>
                        </div>

                        <h5 style="margin: 15px 0 5px 0;">Talh√µes</h5>
                        <div class="form-grid" style="grid-template-columns: 1fr 1fr 1fr auto; align-items: end; margin-bottom: 10px;">
                            <div class="form-group">
                                <label for="liberacao-talhao-add">Talh√£o</label>
                                <select id="liberacao-talhao-add">
                                    <option value="">Selecione...</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="liberacao-variedade-add">Variedade</label>
                                <input type="text" id="liberacao-variedade-add" placeholder="Variedade">
                            </div>
                            <div class="form-group">
                                <label for="liberacao-area-add">√Årea (ha)</label>
                                <input type="number" id="liberacao-area-add" step="0.01" placeholder="0.00">
                            </div>
                            <button type="button" class="btn btn-secondary" id="btn-add-liberacao-talhao">Adicionar</button>
                        </div>

                        <div class="table-container" style="max-height: 150px; overflow-y: auto;">
                            <table class="data-table">
                                <thead>
                                    <tr>
                                        <th>Talh√£o</th>
                                        <th>Variedade</th>
                                        <th>√Årea (ha)</th>
                                        <th>A√ß√£o</th>
                                    </tr>
                                </thead>
                                <tbody id="liberacao-talhoes-body">
                                    <!-- JS -->
                                </tbody>
                                <tfoot>
                                    <tr>
                                        <td colspan="2" style="text-align: right; font-weight: bold;">Total:</td>
                                        <td colspan="2" id="liberacao-total-ha" style="font-weight: bold;">0.00 ha</td>
                                    </tr>
                                </tfoot>
                            </table>
                        </div>

                        <div class="form-group full-width" style="margin-top: 15px;">
                            <label for="liberacao-obs">Observa√ß√µes</label>
                            <textarea id="liberacao-obs" rows="3" style="width: 100%; border: 1px solid var(--border); border-radius: 8px; padding: 8px; font-family: inherit;"></textarea>
                        </div>
                        
                        <div style="margin-top:20px;display:flex;gap:10px;justify-content:flex-end;">
                            <button type="button" class="btn btn-primary" id="btn-save-liberacao">üíæ Salvar Libera√ß√£o</button>
                        </div>
                    </form>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary close-liberacao-modal">Fechar</button>
            </div>
        </div>
    </div>


    <!-- Modal Novo Lan√ßamento Plantio -->
    <div id="novo-lancamento-modal" class="modal" style="display: none;">
        <div class="modal-content large-modal" style="max-width: 95%;">
            <div class="modal-header">
                <h3 id="modal-novo-plantio-title">Novo Lan√ßamento de Plantio</h3>
                <button class="close-modal close-novo-lancamento-modal">&times;</button>
            </div>
            <div class="modal-body">


                <!-- Summary Panel -->
                <div class="modal-summary-panel">
                    <div><strong>Data:</strong> <span id="summary-data">-</span></div>
                    <div><strong>Frente:</strong> <span id="summary-frente">-</span></div>
                    <div><strong>Plantio:</strong> <span id="summary-area">0.00</span> ha</div>
                    <div><strong>Total:</strong> R$ <span id="summary-custo">0.00</span></div>
                </div>

                <!-- Steps Navigation -->
                <div class="modal-steps">
                    <button class="step-btn active" data-step="1">1. Dados Operacionais</button>
                    <button class="step-btn" data-step="2">2. Insumos</button>
                    <button class="step-btn" data-step="3">3. Qualidade</button>
                </div>

                <!-- Step 1 Content -->
                <div class="step-content active" data-step="1">
                    <div class="chart-card form-card">
                        <h4 class="section-title">Identifica√ß√£o & Local</h4>
                        <div class="modal-form-grid">
                            <!-- Qualidade Type Toggle (Moved from Step 3) -->
                            <div class="form-group" id="qualidade-tipo-container" style="display: none; grid-column: span 2;">
                                 <label for="qualidade-tipo-select" style="font-weight: bold;">Tipo de Qualidade:</label>
                                 <select id="qualidade-tipo-select" style="font-weight: bold; border: 2px solid var(--primary); padding: 8px; width: 100%;">
                                     <option value="plantio_cana">Plantio de Cana</option>
                                     <option value="colheita_muda">Colheita de Muda</option>
                                 </select>
                            </div>

                            <div class="form-group hide-in-quality">
                                <label for="tipo-operacao">Tipo de Opera√ß√£o *</label>
                                <select id="tipo-operacao" style="font-weight:bold; border-color: var(--primary);">
                                    <option value="plantio">Plantio de Cana</option>
                                    <option value="colheita_muda">Colheita de Muda</option>
                                    <!-- Qualidade de Muda removida daqui pois tem bot√£o pr√≥prio -->
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="plantio-data">Data *</label>
                                <input type="date" id="plantio-data" class="highlight-input">
                                <div class="validation-msg" id="msg-plantio-data">Data √© obrigat√≥ria</div>
                            </div>
                            <div class="form-group">
                                <label for="plantio-hora">Hora</label>
                                <input type="time" id="plantio-hora" class="highlight-input">
                            </div>
                            <div class="form-group hide-in-quality">
                                <label for="chuva-mm">Chuva (mm)</label>
                                <input type="number" id="chuva-mm" step="0.1" placeholder="0.0">
                            </div>
                             <div class="form-group">
                                <label for="plantio-responsavel">
                                    <span class="default-label">Respons√°vel</span>
                                    <span class="show-in-quality-only" style="display:none">Respons√°vel pela Qualidade</span>
                                </label>
                                <input type="text" id="plantio-responsavel" placeholder="Nome">
                            </div>
                            <div class="form-group show-in-quality-only" style="display: none;">
                                <label for="qual-matricula-header">Matr√≠cula</label>
                                <input type="text" id="qual-matricula-header" placeholder="Registro">
                            </div>
                            
                            <div class="form-group" style="grid-column: span 2;">
                                <label for="single-os">O.S *</label>
                                <select id="single-os" class="highlight-input" style="font-weight:bold; border-color: var(--secondary);">
                                    <option value="">Selecione a O.S</option>
                                </select>
                                <div class="validation-msg" id="msg-single-os">Selecione uma O.S</div>
                            </div>
                            <div class="form-group hide-in-quality" style="grid-column: span 2;">
                                <label for="single-frente">Frente</label>
                                <select id="single-frente" class="readonly-field" disabled title="Auto O.S">
                                    <option value="">Auto pela O.S</option>
                                </select>
                            </div>
                        </div>
                    </div>

                            <div class="chart-card form-card hide-in-quality">
                                <h4 class="section-title">Produ√ß√£o & √Årea</h4>
                                <div class="modal-form-grid">
                                     <div class="form-group">
                                        <label for="single-fazenda">Fazenda</label>
                                <select id="single-fazenda" class="readonly-field" disabled title="Auto OS">
                                    <option value="">Selecione a Fazenda</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="single-cod">C√≥digo</label>
                                <input type="text" id="single-cod" class="readonly-field" readonly title="Auto OS">
                            </div>
                             <div class="form-group">
                                <label for="single-regiao">Regi√£o</label>
                                <input type="text" id="single-regiao" class="readonly-field" readonly title="Auto OS">
                            </div>
                            <div class="form-group">
                                 <label for="single-area-total">√Årea Fazenda (ha)</label>
                                 <input type="number" id="single-area-total" class="readonly-field" readonly>
                            </div>
                            
                            <div class="form-group" style="grid-column: span 2; background: rgba(46, 125, 50, 0.1); padding: 10px; border-radius: 8px; border: 1px solid var(--primary);">
                                <label for="single-plantio-dia" style="color: var(--primary-dark); font-size: 1.1em; font-weight: bold;">üåø Plantio dia (ha) *</label>
                                <input type="number" id="single-plantio-dia" class="highlight-input" step="0.01" placeholder="0.00" style="font-size: 1.2em;">
                                <div class="validation-msg" id="msg-single-plantio-dia">Informe a √°rea plantada</div>
                            </div>
                            
                            <div class="form-group">
                                <label for="single-area">√Årea Planejada OS</label>
                                <input type="number" id="single-area" class="readonly-field" readonly>
                            </div>
                            <div class="form-group">
                                <label for="single-area-acumulada">Acumulado</label>
                                <input type="number" id="single-area-acumulada" step="0.01" class="readonly-field" readonly>
                            </div>
                             <div class="form-group">
                                <label for="cobricao-dia">Cobri√ß√£o Dia</label>
                                <input type="number" id="cobricao-dia" step="0.01" placeholder="0.00">
                            </div>
                            <div class="form-group">
                                <label for="cobricao-acumulada">Cobri√ß√£o Acum.</label>
                                <input type="number" id="cobricao-acumulada" step="0.01" class="readonly-field" readonly>
                            </div>
                            <div class="form-group hide-in-quality" style="grid-column: span 2;">
                                <label for="plantio-obs">Observa√ß√µes</label>
                                <input type="text" id="plantio-obs" placeholder="Opcional">
                            </div>
                        </div>
                    </div>

                    <!-- Colheita Muda (Hidden) -->
                    <div class="chart-card form-card" id="sec-colheita-producao-card" style="display: none;">
                        <h4 class="section-title">Produ√ß√£o Colheita Muda</h4>
                        <div class="modal-form-grid">
                            <div class="form-group">
                                <label for="colheita-hectares">Hectares colhidos</label>
                                <input type="number" id="colheita-hectares" step="0.01">
                            </div>
                            <div class="form-group">
                                <label for="colheita-tch-estimado">TCH estimado</label>
                                <input type="number" id="colheita-tch-estimado" step="0.01">
                            </div>
                            <div class="form-group">
                                <label for="colheita-tch-real">TCH real</label>
                                <input type="number" id="colheita-tch-real" step="0.01">
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Step 2 Content -->
                <div class="step-content" data-step="2">
                    <div class="chart-card form-card">
                        <h4 class="section-title">Gest√£o de Insumos</h4>
                        <div class="modal-form-grid">
                             <div class="form-group" style="grid-column: span 2;">
                                <label for="insumo-produto">Produto</label>
                                <select id="insumo-produto" style="width: 100%;">
                                    <option value="">Selecione o produto...</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="insumo-dose-prevista">Dose Prev. (L/kg ha)</label>
                                <input type="number" id="insumo-dose-prevista" step="0.001" placeholder="0.000" readonly style="background-color: #e9ecef; cursor: not-allowed;">
                            </div>
                            <div class="form-group">
                                <label for="insumo-qtd-total">Qtd. Total Usada</label>
                                <input type="number" id="insumo-qtd-total" step="0.001" placeholder="Total">
                            </div>
                            <div class="form-group" style="grid-column: span 2;">
                                <button id="btn-add-insumo-row" class="btn btn-secondary" style="width: 100%;">‚ûï Adicionar Insumo</button>
                            </div>
                        </div>
                        
                        <div class="table-container" style="max-height: 300px; overflow-y: auto; margin-top: 15px;">
                            <table class="data-table">
                                <thead>
                                    <tr>
                                        <th>Produto</th>
                                        <th>Dose Prev.</th>
                                        <th>Dose Real.</th>
                                        <th>Total Prev.</th>
                                        <th>Total Real.</th>
                                        <th style="width: 50px;">A√ß√£o</th>
                                    </tr>
                                </thead>
                                <tbody id="insumos-plantio-tbody">
                                    <!-- Insumos adicionados aparecem aqui -->
                                </tbody>
                            </table>
                        </div>
                        <div id="insumos-total-gasto" style="text-align: right; font-weight: bold; margin-top: 10px; font-size: 1.1em; color: var(--primary-dark);">
                            Total Gasto no Dia: 0.000
                        </div>
                    </div>
                </div>

                <!-- Step 3 Content -->
                <div class="step-content" data-step="3">
                    
                    <!-- Container para Sele√ß√£o de Qualidade (Apenas modo Plantio) -->
                    <div id="qualidade-selection-container" class="chart-card form-card" style="display: none;">
                        <h4 class="section-title">Vincular Qualidade de Muda</h4>
                        <p class="text-muted">Selecione um registro de qualidade lan√ßado anteriormente para vincular a este plantio.</p>
                        
                        <div id="qualidade-records-list" class="records-list-container" style="max-height: 300px; overflow-y: auto; border: 1px solid var(--border); border-radius: 8px; padding: 10px;">
                            <!-- Lista populada via JS -->
                            <div class="text-center p-3 text-muted">Nenhum registro de qualidade encontrado para esta data/frente.</div>
                        </div>
                        <input type="hidden" id="selected-qualidade-id">
                    </div>

                    <!-- Container Manual (Escondido no modo Plantio, Vis√≠vel no modo Qualidade) -->
                    <div id="qualidade-manual-content">

                    <!-- Equipe e Equipamentos (Comum) -->
                    <div class="chart-card form-card">
                        <h4 class="section-title">Equipe e Equipamentos</h4>
                        <div class="modal-form-grid" style="grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));">
                            <div class="form-group">
                                <label for="qual-equipamento-trator">Trator</label>
                                <input type="text" id="qual-equipamento-trator" placeholder="ID/Modelo">
                            </div>
                            <div class="form-group">
                                <label for="qual-equipamento-plantadora">Plantadora/Colhedora</label>
                                <input type="text" id="qual-equipamento-plantadora" placeholder="ID/Modelo">
                            </div>
                            <div class="form-group">
                                <label for="qual-operador">Operador</label>
                                <input type="text" id="qual-operador" placeholder="Nome">
                            </div>
                            <div class="form-group">
                                <label for="qual-matricula">Matr√≠cula</label>
                                <input type="text" id="qual-matricula" placeholder="Registro">
                            </div>
                        </div>
                    </div>

                    <!-- Qualidade Muda/Plantio -->
                    <div class="chart-card form-card">
                        <h4 class="section-title">Qualidade de Plantio</h4>
                        
                        <!-- Se√ß√£o de IA removida temporariamente -->

                        <!-- Gemas -->
                        <div class="modal-subsection" id="sec-gemas">
                            <h5 style="margin: 0 0 8px 0; color: #666; font-weight: 600;">üß¨ Gemas</h5>
                            <div class="modal-form-grid" style="grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));">
                                <div class="form-group">
                                    <label for="qual-gemas-amostra">Amostra</label>
                                    <input type="number" id="qual-gemas-amostra" step="0.1">
                                </div>
                                <div class="form-group">
                                    <label for="qual-gemas-total">Total</label>
                                    <input type="number" id="qual-gemas-total" step="1">
                                </div>
                                <div class="form-group">
                                    <label for="qual-gemas-media">M√©dia/m</label>
                                    <input type="number" id="qual-gemas-media" step="0.01" class="readonly-field" readonly>
                                </div>
                                <div class="form-group">
                                    <label for="qual-gemas-boas">Vi√°veis</label>
                                    <input type="number" id="qual-gemas-boas" step="1">
                                </div>
                                <div class="form-group">
                                    <label for="qual-gemas-ruins">Invi√°veis</label>
                                    <input type="number" id="qual-gemas-ruins" step="1">
                                </div>
                                <div class="form-group">
                                    <label for="qual-gemas-boas-pct">% Vi√°veis</label>
                                    <input type="number" id="qual-gemas-boas-pct" step="0.01" class="readonly-field" readonly>
                                </div>
                            </div>
                        </div>

                        <!-- Toletes -->
                        <div class="modal-subsection" id="sec-toletes">
                            <h5 style="margin: 0 0 8px 0; color: #666; font-weight: 600;">ü™µ Toletes</h5>
                            <div class="modal-form-grid" style="grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));">
                                <div class="form-group">
                                    <label for="qual-toletes-amostra">Amostra</label>
                                    <input type="number" id="qual-toletes-amostra" step="0.1">
                                </div>
                                <div class="form-group">
                                    <label for="qual-toletes-total">Total</label>
                                    <input type="number" id="qual-toletes-total" step="1">
                                </div>
                                <div class="form-group">
                                    <label for="qual-toletes-media">M√©dia/m</label>
                                    <input type="number" id="qual-toletes-media" step="0.01" class="readonly-field" readonly>
                                </div>
                                <div class="form-group">
                                    <label for="qual-toletes-bons">Bons</label>
                                    <input type="number" id="qual-toletes-bons" step="1">
                                </div>
                                <div class="form-group">
                                    <label for="qual-toletes-ruins">Ruins</label>
                                    <input type="number" id="qual-toletes-ruins" step="1">
                                </div>
                                <div class="form-group">
                                    <label for="qual-toletes-bons-pct">% Bons</label>
                                    <input type="number" id="qual-toletes-bons-pct" step="0.01" class="readonly-field" readonly>
                                </div>
                            </div>
                        </div>

                        <!-- Outros -->
                        <div id="sec-outros">
                            <h5 style="margin: 10px 0 5px 0; color: #666;">Outros Indicadores</h5>
                            <div class="modal-form-grid">
                                <div class="form-group">
                                    <label for="qual-muda">Muda (ton/ha)</label>
                                    <input type="number" id="qual-muda" step="0.01">
                                </div>
                                <div class="form-group">
                                    <label for="qual-profundidade">Profundidade (cm)</label>
                                    <input type="number" id="qual-profundidade" step="0.1">
                                </div>
                                <div class="form-group">
                                    <label for="qual-cobertura">Cobertura</label>
                                    <input type="text" id="qual-cobertura">
                                </div>
                                <div class="form-group">
                                    <label for="qual-alinhamento">Espa√ßamento</label>
                                    <input type="text" id="qual-alinhamento">
                                </div>
                            </div>
                        </div>
                    </div><!-- End qualidade-manual-content part 1 -->

                    <!-- Muda Consumo -->
                    <div class="chart-card form-card" id="sec-muda-consumo-card">
                        <h4 class="section-title">Consumo de Muda</h4>
                        <div class="modal-form-grid">
                            <div class="form-group">
                                <label for="muda-consumo-total">Consumo total (ton)</label>
                                <input type="number" id="muda-consumo-total" step="0.01">
                            </div>
                            <div class="form-group">
                                <label for="muda-consumo-acumulado">Consumo acum. (ton)</label>
                                <input type="number" id="muda-consumo-acumulado" step="0.01" class="readonly-field" readonly>
                            </div>
                            <div class="form-group">
                                <label for="muda-consumo-dia">Consumo dia (ton)</label>
                                <input type="number" id="muda-consumo-dia" step="0.01">
                            </div>
                            <div class="form-group">
                                <label for="muda-previsto">Previsto (ton)</label>
                                <input type="number" id="muda-previsto" step="0.01">
                            </div>
                            <div class="form-group">
                                <label for="muda-liberacao-fazenda">Libera√ß√£o fazenda</label>
                                <input type="text" id="muda-liberacao-fazenda" class="highlight-input">
                            </div>
                            <div class="form-group">
                                <label for="muda-variedade">Variedade</label>
                                <input type="text" id="muda-variedade">
                            </div>
                        </div>
                    </div>

                    <!-- Qualidade Muda -->
                    <div class="chart-card form-card qualidade-manual-block">
                         <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; border-bottom: 1px solid var(--border); padding-bottom: 10px;">
                            <h4 class="section-title" style="margin: 0; border: none; padding: 0;">Origem & Qualidade da Muda</h4>
                         </div>
                         <div class="modal-subsection" id="sec-mudas">
                            <div class="modal-form-grid" style="grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));">

                                <div class="form-group">
                                    <label for="muda-colheita-info">Libera√ß√£o de Colheita</label>
                                    <select id="muda-colheita-info" class="highlight-input">
                                        <option value="">Selecione...</option>
                                    </select>
                                </div>
                                <div class="form-group" style="display: none;">
                                    <label for="qual-muda-liberacao">Libera√ß√£o</label>
                                    <input type="text" id="qual-muda-liberacao">
                                </div>
                                <div class="form-group">
                                    <label for="muda-fazenda-origem">Fazenda Origem</label>
                                    <input type="text" id="muda-fazenda-origem">
                                </div>
                                <div class="form-group">
                                    <label for="muda-talhao-origem">Talh√£o Origem</label>
                                    <input type="text" id="muda-talhao-origem">
                                </div>
                                <div class="form-group">
                                    <label for="qual-muda-variedade">Variedade</label>
                                    <input type="text" id="qual-muda-variedade">
                                </div>

                                <div class="form-group">
                                    <label for="qual-mudas-amostra-fixo">Amostra Fixa</label>
                                    <input type="text" id="qual-mudas-amostra-fixo" value="100 toletes" readonly style="background-color: #e9ecef;">
                                </div>
                                <div class="form-group">
                                    <label for="qual-mudas-total">Total gemas</label>
                                    <input type="number" id="qual-mudas-total" step="1">
                                </div>
                                <div class="form-group">
                                    <label for="qual-mudas-boas">Gemas boas</label>
                                    <input type="number" id="qual-mudas-boas" step="1">
                                </div>
                                <div class="form-group">
                                    <label for="qual-mudas-ruins">Gemas ruins</label>
                                    <input type="number" id="qual-mudas-ruins" step="1">
                                </div>
                                <div class="form-group">
                                    <label for="qual-mudas-boas-pct">% Boas (>80%)</label>
                                    <input type="number" id="qual-mudas-boas-pct" step="0.01" class="readonly-field" readonly>
                                </div>
                                <div class="form-group">
                                    <label for="qual-mudas-reboulos">Total Reboulos</label>
                                    <input type="number" id="qual-mudas-reboulos" step="1">
                                </div>
                                <div class="form-group">
                                    <label for="qual-mudas-reboulos-bons">Reboulos Bons</label>
                                    <input type="number" id="qual-mudas-reboulos-bons" step="1">
                                </div>
                                <div class="form-group">
                                    <label for="qual-mudas-reboulos-ruins">Reboulos Ruins</label>
                                    <input type="number" id="qual-mudas-reboulos-ruins" step="1">
                                </div>
                                <div class="form-group">
                                    <label for="qual-mudas-reboulos-bons-pct">% Bons</label>
                                    <input type="number" id="qual-mudas-reboulos-bons-pct" step="0.01" class="readonly-field" readonly>
                                </div>
                                <div class="form-group">
                                    <label for="qual-mudas-reboulos-ruins-pct">% Ruins</label>
                                    <input type="number" id="qual-mudas-reboulos-ruins-pct" step="0.01" class="readonly-field" readonly>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="step-footer">
                    <button class="btn btn-secondary close-novo-lancamento-modal">Cancelar</button>
                    <div style="flex: 1;"></div>
                    <button id="step-prev-btn" class="btn btn-secondary" style="display: none; margin-right: 10px;">‚ùÆ Anterior</button>
                    <button id="step-next-btn" class="btn btn-primary">Pr√≥ximo ‚ùØ</button>
                    <button id="plantio-save-btn" class="btn btn-primary" style="display: none; padding: 10px 25px; font-size: 1.1em;">üíæ Registrar Dia</button>
                </div>
        </div>
    </div>


    <!-- Modal Transporte de Composto -->
    <div id="modal-transporte-composto" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Cadastro de Transporte de Composto</h3>
                <span class="close-modal close-composto-modal" style="cursor: pointer;">&times;</span>
            </div>
            <div class="modal-body">
            <form id="form-transporte-composto">
                <input type="hidden" name="id" id="composto-id">
                <div class="form-grid boletim-grid">
                    <div class="form-group">
                        <label>N¬∫ OS *</label>
                        <input type="text" name="numero_os" id="composto-numero-os" required>
                    </div>
                    <div class="form-group">
                        <label>Data Abertura</label>
                        <input type="date" name="data_abertura" id="composto-data-abertura">
                    </div>
                    <div class="form-group">
                        <label>Respons√°vel</label>
                        <input type="text" name="responsavel_aplicacao" id="composto-responsavel">
                    </div>
                    <div class="form-group">
                        <label>Empresa</label>
                        <input type="text" name="empresa" id="composto-empresa">
                    </div>
                    <div class="form-group">
                        <label>C√≥d. Fazenda</label>
                        <input type="number" name="fazenda_codigo" id="composto-fazenda-codigo">
                    </div>
                    <div class="form-group">
                        <label>Fazenda</label>
                        <select name="fazenda" id="composto-fazenda">
                            <option value="">Selecione a Fazenda...</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Frente</label>
                        <input type="text" name="frente" id="composto-frente">
                    </div>
                    <div class="form-group">
                        <label>Produto</label>
                        <input type="text" name="produto" id="composto-produto" value="COMPOSTO">
                    </div>
                    <div class="form-group">
                        <label>Quantidade (t)</label>
                        <input type="number" step="0.001" name="quantidade" id="composto-quantidade">
                    </div>
                    <div class="form-group">
                        <label>Unidade</label>
                        <input type="text" name="unidade" id="composto-unidade" value="t">
                    </div>
                    <div class="form-group">
                        <label>Atividade</label>
                        <input type="text" name="atividade_agricola" id="composto-atividade">
                    </div>
                    <div class="form-group">
                        <label>Status</label>
                        <select name="status" id="composto-status">
                            <option value="ABERTO">ABERTO</option>
                            <option value="FECHADO">FECHADO</option>
                        </select>
                    </div>
                </div>

                <!-- Transportes Di√°rios -->
                <h5 style="margin: 20px 0 10px 0; border-top: 1px solid #eee; padding-top: 15px;">Transportes Di√°rios</h5>
                
                <!-- Summary Block -->
                <div class="summary-block-theme" style="display: flex; gap: 20px; padding: 10px; border-radius: 4px; margin-bottom: 10px; font-size: 0.9em; align-items: center; justify-content: space-around; border: 1px solid #ddd;">
                    <div><strong>Meta da O.S.:</strong> <span id="summary-composto-meta">0.000</span> t</div>
                    <div><strong>Realizado:</strong> <span id="summary-composto-realizado" style="color: blue;">0.000</span> t</div>
                    <div><strong>Restante:</strong> <span id="summary-composto-restante" style="font-weight: bold;">0.000</span> t</div>
                </div>

                <div class="form-grid" style="grid-template-columns: auto auto auto auto; align-items: end; margin-bottom: 10px; gap: 10px;">
                    <div class="form-group">
                        <label>Data</label>
                        <input type="date" id="composto-diario-data">
                    </div>
                    <div class="form-group">
                        <label>Qtd (t)</label>
                        <input type="number" step="0.001" id="composto-diario-qtd">
                    </div>
                    <div class="form-group">
                        <label>Frota/Caminh√£o</label>
                        <input type="text" id="composto-diario-frota" placeholder="Placa ou ID">
                    </div>
                    <button type="button" class="btn btn-secondary" id="btn-add-composto-diario">‚ûï Adicionar</button>
                </div>

                <div class="table-container" style="max-height: 200px; overflow-y: auto; margin-bottom: 15px;">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Data</th>
                                <th>Quantidade (t)</th>
                                <th>Frota</th>
                                <th>A√ß√µes</th>
                            </tr>
                        </thead>
                        <tbody id="composto-diario-body">
                            <!-- JS Render -->
                        </tbody>
                        <tfoot>
                            <tr>
                                <th>Total</th>
                                <th id="composto-diario-total">0.000</th>
                                <th colspan="2"></th>
                            </tr>
                        </tfoot>
                    </table>
                </div>

                <div class="form-actions" style="margin-top: 15px; display: flex; justify-content: flex-end; gap: 10px;">
                    <button type="button" class="btn btn-secondary" id="btn-print-composto-detail" title="Imprimir Detalhes">üñ®Ô∏è Imprimir</button>
                    <button type="button" class="btn btn-secondary close-composto-modal">Cancelar</button>
                    <button type="button" id="btn-composto-clear" class="btn btn-secondary">Limpar</button>
                    <button type="submit" id="btn-composto-save" class="btn btn-primary">üíæ Salvar Transporte</button>
                </div>
            </form>
        </div>
    </div>


    <!-- Modal Viagem Adubo (Standardized) -->
    <div id="modal-viagem-adubo" class="modal" style="display: none;">
        <div class="modal-content" style="width: 80%; max-width: 900px;">
            <div class="modal-header">
                <h3>Cadastro de Viagem (Adubo)</h3>
                <span class="close-modal close-viagem-adubo-modal" style="cursor: pointer;">&times;</span>
            </div>
            <div class="modal-body">
                <div class="form-grid boletim-grid">
                    <div class="form-group">
                        <label for="modal-viagem-data">Data</label>
                        <input type="date" id="modal-viagem-data">
                    </div>
                    <!-- Campo OS para Adubo Modal -->
                    <div class="form-group adubo-field">
                        <label for="modal-viagem-adubo-os">N√∫mero da OS</label>
                        <select id="modal-viagem-adubo-os" class="form-control">
                            <option value="">Selecione a OS</option>
                        </select>
                    </div>
                    <div class="form-group adubo-field">
                        <label for="modal-viagem-frente">Frente</label>
                        <input type="text" id="modal-viagem-frente" placeholder="Ex.: 4001">
                    </div>
                    <div class="form-group">
                        <label for="modal-viagem-codigo-fazenda">C√≥digo</label>
                        <select id="modal-viagem-codigo-fazenda">
                            <option value="">Selecione</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="modal-viagem-fazenda">Fazenda</label>
                        <select id="modal-viagem-fazenda">
                            <option value="">Selecione a Fazenda</option>
                        </select>
                    </div>
                    <div class="form-group adubo-field">
                        <label for="modal-viagem-origem">Origem</label>
                        <input type="text" id="modal-viagem-origem" placeholder="Ex.: Armaz√©m A">
                    </div>
                    <div class="form-group adubo-field">
                        <label for="modal-viagem-destino">Destino</label>
                        <input type="text" id="modal-viagem-destino" placeholder="Ex.: Talh√£o 1">
                    </div>
                    <div class="form-group">
                        <label for="modal-viagem-produto">Produto</label>
                        <select id="modal-viagem-produto">
                            <option value="">Selecione</option>
                            <option>BIOZYME</option>
                            <option>04-30-10</option>
                            <option>QUALITY</option>
                            <option>AZOKOP</option>
                            <option>SURVEY (FIPRONIL)</option>
                            <option>OXIFERTIL</option>
                            <option>LANEX 800 WG (REGENTE)</option>
                            <option>COMET</option>
                            <option>COMPOSTO</option>
                            <option>10-49-00</option>
                            <option>PEREGRINO</option>
                            <option>NO-NEMA</option>
                            <option value="Outro">Outro</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="modal-viagem-quantidade-total">Quantidade (t)</label>
                        <input type="number" id="modal-viagem-quantidade-total" step="0.001">
                    </div>
                    <div class="form-group adubo-field">
                        <label for="modal-viagem-unidade">Unidade</label>
                        <select id="modal-viagem-unidade">
                            <option value="">Selecione</option>
                            <option value="t">t</option>
                            <option value="kg">kg</option>
                            <option value="L">L</option>
                            <option value="sc">sc</option>
                            <option value="bag">bag</option>
                        </select>
                    </div>
                    <div class="form-group adubo-field">
                        <label for="modal-viagem-caminhao">Caminh√£o</label>
                        <input type="text" id="modal-viagem-caminhao" placeholder="Placa / identifica√ß√£o">
                    </div>
                    <div class="form-group adubo-field">
                        <label for="modal-viagem-carreta1">Carreta 1</label>
                        <input type="text" id="modal-viagem-carreta1" placeholder="Opcional">
                    </div>
                    <div class="form-group adubo-field">
                        <label for="modal-viagem-carreta2">Carreta 2</label>
                        <input type="text" id="modal-viagem-carreta2" placeholder="Opcional">
                    </div>
                    <div class="form-group adubo-field">
                        <label for="modal-viagem-motorista">Motorista</label>
                        <input type="text" id="modal-viagem-motorista">
                    </div>
                    <div class="form-group adubo-field">
                        <label for="modal-viagem-documento-motorista">Doc. Motorista</label>
                        <input type="text" id="modal-viagem-documento-motorista" placeholder="CPF / CNH">
                    </div>
                    <div class="form-group adubo-field">
                        <label for="modal-viagem-transportadora">Transportadora</label>
                        <input type="text" id="modal-viagem-transportadora">
                    </div>
                    <div class="form-group">
                        <label for="modal-viagem-observacoes">Observa√ß√µes</label>
                        <input type="text" id="modal-viagem-observacoes" placeholder="Opcional">
                    </div>
                </div>

                <div class="chart-card form-card" id="modal-viagem-bags-section" style="margin-top: 15px;">
                    <h4 style="margin: 0 0 10px 0;">Bags da Viagem</h4>
                    <div class="form-grid boletim-grid">
                        <div class="form-group">
                            <label for="modal-bag-identificacao">Identifica√ß√£o</label>
                            <input type="text" id="modal-bag-identificacao" placeholder="Ex.: BAG 001">
                        </div>
                        <div class="form-group">
                            <label for="modal-bag-lacre">Lacre</label>
                            <input type="text" id="modal-bag-lacre" placeholder="Lacre / selo">
                        </div>
                        <div class="form-group">
                            <label for="modal-bag-observacoes">Observa√ß√µes</label>
                            <input type="text" id="modal-bag-observacoes" placeholder="Opcional">
                        </div>
                    </div>
                    <div style="margin-top:10px; display:flex; gap:10px;">
                        <button id="modal-bag-add-btn" class="btn btn-secondary">‚ûï Adicionar Bag</button>
                    </div>
                    <div class="table-container" style="margin-top:10px;">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Identifica√ß√£o</th>
                                    <th>Lacre</th>
                                    <th>Observa√ß√µes</th>
                                    <th>A√ß√µes</th>
                                </tr>
                            </thead>
                            <tbody id="modal-bags-table-body"></tbody>
                        </table>
                    </div>
                </div>
            </div>
            <div class="modal-footer" style="margin-top: 15px; display: flex; justify-content: flex-end; gap: 10px; border-top: 1px solid #eee; padding-top: 15px;">
                     <button type="button" class="btn btn-secondary" id="modal-btn-print-viagem-adubo" title="Imprimir Detalhes">üñ®Ô∏è Imprimir</button>
                     <button type="button" class="btn btn-secondary close-viagem-adubo-modal">Cancelar</button>
                     <button type="button" id="btn-save-viagem-fix" class="btn btn-primary" style="position: relative; z-index: 10000; cursor: pointer;" onclick="window.forceSaveViagemAdubo(true)">üíæ Registrar Viagem</button>
                </div>
        </div>
    </div>

    <!-- Generic Alert Modal (Center Screen) -->
    <div id="alert-modal" class="modal" style="display: none; z-index: 99999;">
        <div class="modal-content" style="max-width: 500px; text-align: center; border-left: 5px solid #ef4444;">
            <div style="margin-bottom: 20px;">
                <span style="font-size: 3em;">‚ö†Ô∏è</span>
            </div>
            <h3 id="alert-modal-title" style="color: #ef4444; margin-bottom: 15px;">Alerta de Estoque</h3>
            <div id="alert-modal-message" style="margin-bottom: 20px; font-size: 1.1em; text-align: left; background: #fef2f2; padding: 15px; border-radius: 8px;"></div>
            <div class="modal-footer" style="flex-direction: column; align-items: center; border-top: none; gap: 10px;">
                <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 5px;">
                    <input type="checkbox" id="alert-snooze-check" style="width: 16px; height: 16px; cursor: pointer;">
                    <label for="alert-snooze-check" style="font-size: 0.9em; cursor: pointer; user-select: none; color: #555;">N√£o mostrar novamente por 1 hora</label>
                </div>
                <button type="button" class="btn btn-primary" onclick="const snooze = document.getElementById('alert-snooze-check').checked; if(snooze) localStorage.setItem('alert_snooze_until', Date.now() + 3600000); document.getElementById('alert-modal').style.display='none'">Entendido</button>
            </div>
        </div>
    </div>

    <!-- Confirmation Alert Modal (Cloned from Stock Alert) -->
    <div id="confirmation-modal" class="modal" style="display: none; z-index: 100000;">
        <div class="modal-content" style="max-width: 500px; text-align: center; border-left: 5px solid #ef4444;">
            <div style="margin-bottom: 20px;">
                <span style="font-size: 3em;">‚ö†Ô∏è</span>
            </div>
            <h3 id="confirmation-modal-title" style="color: #ef4444; margin-bottom: 15px;">Confirma√ß√£o Necess√°ria</h3>
            <div id="confirmation-modal-message" style="margin-bottom: 20px; font-size: 1.1em; text-align: left; background: #fef2f2; padding: 15px; border-radius: 8px; white-space: pre-line;"></div>
            <div class="modal-footer" style="display: flex; justify-content: center; gap: 15px; border-top: none;">
                <button type="button" class="btn btn-secondary" id="btn-confirm-no" style="min-width: 100px;">Cancelar</button>
                <button type="button" class="btn btn-primary" id="btn-confirm-yes" style="min-width: 100px; background-color: #ef4444; border-color: #ef4444;">Continuar</button>
            </div>
        </div>
    </div>

 
    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>
    <script>
        // Configurar worker do PDF.js
        if (window.pdfjsLib) {
            window.pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
        }
    </script>
    <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jspdf-autotable@3.5.28/dist/jspdf.plugin.autotable.min.js"></script>
    
    <script>
        // Global Error Handler for "Scenario C" (Script loading failures)
        window.onerror = function(msg, url, line, col, error) {
            alert("Erro Cr√≠tico do Sistema:\n" + msg + "\n\nSe o problema persistir, recarregue a p√°gina com Ctrl+F5.");
            console.error("Global Error:", {msg, url, line, col, error});
            return false;
        };
        window.addEventListener('unhandledrejection', function(event) {
            console.error("Unhandled Rejection:", event.reason);
            // alert("Erro de comunica√ß√£o com servidor ou l√≥gica ass√≠ncrona:\n" + event.reason);
        });
    </script>
    <!-- Modal Lista Qualidade de Muda (Hist√≥rico) -->
    <div id="qualidade-list-modal" class="modal" style="display: none; z-index: 1100;">
        <div class="modal-content" style="max-width: 900px; max-height: 90vh;">
            <div class="modal-header">
                <h3>Hist√≥rico de Qualidade de Muda</h3>
                <button class="close-modal" onclick="document.getElementById('qualidade-list-modal').style.display='none'">&times;</button>
            </div>
            <div class="modal-body">
                <div class="table-container" style="max-height: 60vh; overflow-y: auto;">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Data</th>
                                <th>Fazenda/Frente</th>
                                <th>Variedade</th>
                                <th>√çndice Qualidade</th>
                                <th>A√ß√µes</th>
                            </tr>
                        </thead>
                        <tbody id="qualidade-list-body">
                            <tr><td colspan="5" class="loading">Carregando...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="document.getElementById('qualidade-list-modal').style.display='none'">Fechar</button>
            </div>
        </div>
    </div>

    <!-- Supabase & Config -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.3/dist/umd/supabase.js"></script>
    <script src="config.js?v=ADUBO-OS-FIX-49-FLOW-DEBUG"></script>
    
    <script src="api.js?v=ADUBO-OS-FIX-49-FLOW-DEBUG"></script>
    <script src="ui.js?v=ADUBO-OS-FIX-49-FLOW-DEBUG"></script>
    <script src="import.js?v=ADUBO-OS-FIX-49-FLOW-DEBUG"></script>
    <script src="app.js?v=ADUBO-OS-FIX-52-ROBUST-FALLBACK"></script>
    
    <script>
    // FIX DE EMERG√äNCIA - BYPASS DE CACHE PARA SAVE VIAGEM
    window.forceSaveViagemAdubo = async function(isModal = false) {
        //alert('DEBUG: forceSaveViagemAdubo INICIADO!');
        
        // UI Feedback for Modal Button
        let btnSaveModal = null;
        let originalText = '';
        if (isModal) {
            btnSaveModal = document.getElementById('btn-save-viagem-fix');
            if (btnSaveModal) {
                originalText = btnSaveModal.innerText;
                btnSaveModal.innerText = 'Salvando...';
                btnSaveModal.disabled = true;
            }
        }

        try {
            // Verificar depend√™ncias
            if (!window.insumosApp || !window.insumosApp.api) {
                 throw new Error('Sistema n√£o inicializado corretamente. Recarregue a p√°gina.');
            }
            
            const app = window.insumosApp;
            const prefix = isModal ? 'modal-' : '';
            const getVal = (id) => {
                const el = document.getElementById(prefix + id);
                return el ? el.value : '';
            };

            const data = getVal('viagem-data');
            const fazenda = getVal('viagem-fazenda');
            const produto = getVal('viagem-produto');
            const qtdStr = getVal('viagem-quantidade-total');
            const quantidadeTotalNum = parseFloat((qtdStr || '').toString().replace(',', '.'));
            
            // alert(`DEBUG VALORES:\nData: ${data}\nFazenda: ${fazenda}\nProduto: ${produto}\nQtd: ${qtdStr} -> ${quantidadeTotalNum}`);

            // Reset errors
            ['viagem-data', 'viagem-fazenda', 'viagem-produto', 'viagem-quantidade-total'].forEach(id => {
                const el = document.getElementById(prefix + id);
                if (el) el.classList.remove('input-error');
            });

            if (!data || !fazenda || !produto || isNaN(quantidadeTotalNum)) {
                let missing = [];
                if (!data) { missing.push('Data'); document.getElementById(prefix + 'viagem-data')?.classList.add('input-error'); }
                if (!fazenda) { missing.push('Fazenda'); document.getElementById(prefix + 'viagem-fazenda')?.classList.add('input-error'); }
                if (!produto) { missing.push('Produto'); document.getElementById(prefix + 'viagem-produto')?.classList.add('input-error'); }
                if (isNaN(quantidadeTotalNum)) { missing.push('Quantidade'); document.getElementById(prefix + 'viagem-quantidade-total')?.classList.add('input-error'); }
                
                // alert('DEBUG: Falta campos: ' + missing.join(', '));
                console.warn('Campos obrigat√≥rios ausentes:', missing);
                if (app.ui && app.ui.showNotification) {
                    app.ui.showNotification(`Preencha os campos obrigat√≥rios: ${missing.join(', ')}`, 'warning');
                }
                return; 
            }
     
            const payload = {
                transportType: 'adubo',
                data: data,
                numeroOS: getVal('viagem-adubo-os'),
                frente: getVal('viagem-frente'),
                fazenda: fazenda,
                origem: getVal('viagem-origem'),
                destino: getVal('viagem-destino'),
                produto: produto,
                quantidadeTotal: quantidadeTotalNum,
                unidade: getVal('viagem-unidade'),
                caminhao: getVal('viagem-caminhao'),
                carreta1: getVal('viagem-carreta1'),
                carreta2: getVal('viagem-carreta2'),
                motorista: getVal('viagem-motorista'),
                documentoMotorista: getVal('viagem-documento-motorista'),
                transportadora: getVal('viagem-transportadora'),
                observacoes: getVal('viagem-observacoes'),
                bags: app.viagensAduboBagsDraft || []
            };
            
            // --- Verifica√ß√£o de Limite da OS (Alerta Inteligente) ---
            if (payload.numeroOS && app.osListCache) {
                const os = app.osListCache.find(o => String(o.numero) === String(payload.numeroOS));
                if (os) {
                    let predicted = parseFloat(os.quantidade || 0);
                    // Fallback para c√°lculo Area * Dose se quantidade n√£o definida
                    if (!predicted && os.area_total && os.dose_recomendada) {
                        predicted = parseFloat(os.area_total) * parseFloat(os.dose_recomendada);
                    }
                    
                    if (predicted > 0) {
                        const trips = app.viagensAdubo || [];
                        const currentId = app.currentViagemAduboId;
                        
                        const existingTotal = trips
                            .filter(t => String(t.numero_os) === String(payload.numeroOS) && t.id !== currentId)
                            .reduce((sum, t) => sum + (parseFloat(t.quantidade_total) || 0), 0);
                            
                        const newTotal = existingTotal + payload.quantidadeTotal;
                        
                        if (newTotal > predicted) {
                            const msg = `ATEN√á√ÉO: A quantidade total acumulada (${app.ui.formatNumber(newTotal, 3)}) exceder√° o valor previsto na OS (${app.ui.formatNumber(predicted, 3)}).\n\nPrevisto: ${app.ui.formatNumber(predicted, 3)}\nAcumulado Anterior: ${app.ui.formatNumber(existingTotal, 3)}\nNovo Lan√ßamento: ${app.ui.formatNumber(payload.quantidadeTotal, 3)}\n\nDeseja continuar?`;
                            
                            const confirmed = await app.showConfirmationModal('Alerta de Limite da OS', msg);
                            if (!confirmed) {
                                if (btnSaveModal) {
                                   btnSaveModal.innerText = originalText;
                                   btnSaveModal.disabled = false;
                                }
                                return;
                            }
                        }
                    }
                }
            }
            // --------------------------------------------------------

            let res;
            if (app.currentViagemAduboId) {
                res = await app.api.updateViagemAdubo(app.currentViagemAduboId, payload);
            } else {
                res = await app.api.addViagemAdubo(payload);
            }

            if (res.success) {
                if (app.ui) app.ui.showNotification('Viagem salva com sucesso!', 'success');
                
                // Update Stock logic
                if (payload.frente) {
                    try {
                        if (typeof app.updateEstoqueFromOS === 'function') {
                            await app.updateEstoqueFromOS(payload.frente);
                        }
                        if (typeof app.loadEstoqueAndRender === 'function') {
                            await app.loadEstoqueAndRender();
                        }
                    } catch (stockErr) {
                        console.error('Erro ao atualizar estoque:', stockErr);
                    }
                }

                const modal = document.getElementById('modal-viagem-adubo');
                if (modal) modal.style.display = 'none';
                app.loadViagensAdubo();
            } else {
                throw new Error(res.message);
            }
        } catch (error) {
            console.error('Error saving Viagem Adubo:', error);
            alert('Erro ao salvar: ' + error.message);
        } finally {
            if (btnSaveModal) {
                btnSaveModal.innerText = originalText;
                btnSaveModal.disabled = false;
            }
        }
    };
    </script>
</body>
</html>
